<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for modals, hidden class, dropdowns, etc. */
        .hidden {
            display: none !important;
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        .dropdown-container {
            position: relative;
            display: inline-block;
        }
        .dropdown-menu {
            position: absolute;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 50;
            min-width: 180px;
            display: none; /* Hidden by default */
        }
        .dropdown-menu button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 0.5rem 1rem;
            text-align: left;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.875rem;
            color: #4a5568;
        }
        .dropdown-menu button i {
            margin-right: 0.5rem;
            width: 1rem; /* Ensure consistent icon spacing */
        }
        .dropdown-menu button:hover {
            background-color: #f7fafc;
        }
        .uuid-cell {
            font-family: 'SF Mono', 'Segoe UI Mono', monospace;
            font-size: 0.75rem;
            color: #6B7280;
            word-break: break-all;
        }
        .code-cell {
             font-family: 'SF Mono', 'Segoe UI Mono', monospace;
            font-size: 0.875rem;
        }
        .timestamp-cell {
            font-size: 0.875rem;
            color: #6B7280;
        }
        .numeric-cell {
            text-align: right;
            font-family: 'SF Mono', 'Segoe UI Mono', monospace;
        }
        .action-buttons {
            text-align: center;
        }
        .kebab-button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1em;
            color: #4A5568;
            padding: 0.25rem;
        }
        .kebab-button:hover {
            color: #2D3748;
        }
         #logout-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .logout-modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border-radius: 5px;
            text-align: center;
            position: relative;
        }
        .logout-modal-content button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 15px;
        }
        .logout-modal-content button:hover {
            background-color: #0056b3;
        }
        .countdown {
            font-size: 1.5em;
            font-weight: bold;
            color: #dc3545;
            margin-top: 10px;
        }
    </style>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-gray-800">Group Management Dashboard</h1>

        <div class="mb-6">
            <button id="addGroupButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                <i class="fas fa-plus-circle mr-2"></i>Add New Group
            </button>
            <button id="logoutButton" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded ml-4">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                        <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Group Name</th>
                        <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Reference Code</th>
                        <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Created At</th>
                        <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="groups-table-body">
                    </tbody>
            </table>
            <p id="loading-groups" class="text-center py-4 text-gray-600 hidden">Loading groups...</p>
            <p id="error-groups" class="text-center py-4 text-red-500 hidden"></p>
        </div>
    </div>

    <div id="groupFormModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="groupFormModalTitle" class="text-xl font-semibold mb-4">Add New Group</h2>
            <form id="groupForm" class="space-y-4">
                <input type="hidden" id="groupId">
                <div>
                    <label for="groupName" class="block text-gray-700 text-sm font-bold mb-2">Group Name:</label>
                    <input type="text" id="groupName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="groupReferenceCode" class="block text-gray-700 text-sm font-bold mb-2">Reference Code (Optional):</label>
                    <input type="text" id="groupReferenceCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeGroupFormModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Group</button>
                </div>
            </form>
        </div>
    </div>

    <div id="groupMembersModal" class="modal hidden">
        <div class="modal-content w-full max-w-4xl">
            <h2 id="modalTitle" class="text-xl font-semibold mb-4">Group Members</h2>
            <div class="mb-4">
                <button id="addMemberButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                    <i class="fas fa-user-plus mr-2"></i>Add New Member
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">ID</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Name</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Ticket Type</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Price</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Qty</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Total Due</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount Paid</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Balance Due</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Reference Code</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="group-members-modal-body">
                        </tbody>
                </table>
                <p id="loading-group-members" class="text-center py-4 text-gray-600 hidden">Loading members...</p>
                <p id="error-group-members" class="text-center py-4 text-red-500 hidden"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeGroupMembersModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
    </div>

    <div id="memberFormModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="memberFormModalTitle" class="text-xl font-semibold mb-4">Add New Member</h2>
            <form id="memberForm" class="space-y-4">
                <input type="hidden" id="memberId">
                <input type="hidden" id="memberGroupId"> <div>
                    <label for="memberName" class="block text-gray-700 text-sm font-bold mb-2">Member Name:</label>
                    <input type="text" id="memberName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="memberTicketType" class="block text-gray-700 text-sm font-bold mb-2">Ticket Type:</label>
                    <select id="memberTicketType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="">Select a Ticket Type</option>
                        <option value="Regular">Regular</option>
                        <option value="VIP">VIP</option>
                        <option value="Early Bird">Early Bird</option>
                        <option value="Student">Student</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="memberTicketPrice" class="block text-gray-700 text-sm font-bold mb-2">Ticket Price:</label>
                    <input type="number" id="memberTicketPrice" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="memberQuantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity:</label>
                    <input type="number" id="memberQuantity" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="memberReferenceCode" class="block text-gray-700 text-sm font-bold mb-2">Reference Code (Optional):</label>
                    <input type="text" id="memberReferenceCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeMemberFormModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save Member</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addTicketModal" class="modal hidden">
        <div class="modal-content">
            <h2 id="addTicketModalTitle" class="text-xl font-semibold mb-4">Add Tickets</h2>
            <p class="text-gray-700 mb-4">For: <span id="addTicketMemberName" class="font-semibold"></span></p>
            <form id="addTicketForm" class="space-y-4">
                <input type="hidden" id="addTicketMemberId">
                <input type="hidden" id="addTicketCurrentQuantity">
                <input type="hidden" id="addTicketCurrentTicketType">
                <input type="hidden" id="addTicketCurrentTicketPrice">
                <input type="hidden" id="addTicketExpectedReferenceCode"> <div class="bg-blue-50 p-3 rounded-md mb-4 text-sm text-blue-700">
                    <p>Current Ticket: <span id="currentTicketTypeDisplay" class="font-bold"></span> @ $<span id="currentTicketPriceDisplay" class="font-bold"></span></p>
                </div>

                <div>
                    <label for="addTicketQuantity" class="block text-gray-700 text-sm font-bold mb-2">Quantity to Add:</label>
                    <input type="number" id="addTicketQuantity" min="1" value="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div class="text-sm text-gray-600 italic">
                    Leave "New Ticket Type" and "New Ticket Price" blank to just add more of the current ticket type.
                </div>
                <div>
                    <label for="addTicketType" class="block text-gray-700 text-sm font-bold mb-2">New Ticket Type (Optional, to change primary type):</label>
                    <select id="addTicketType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                        <option value="">-- No Change --</option>
                        <option value="Regular">Regular</option>
                        <option value="VIP">VIP</option>
                        <option value="Early Bird">Early Bird</option>
                        <option value="Student">Student</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="addTicketPrice" class="block text-gray-700 text-sm font-bold mb-2">New Ticket Price (Optional, if new type or price change):</label>
                    <input type="number" id="addTicketPrice" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="addTicketReferenceCode" class="block text-gray-700 text-sm font-bold mb-2">Confirm Reference Code:</label>
                    <input type="text" id="addTicketReferenceCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter member's reference code to confirm" required>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="closeAddTicketModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Update Tickets</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transactionModal" class="modal hidden">
        <div class="modal-content w-full max-w-lg">
            <h2 id="transactionModalTitle" class="text-xl font-semibold mb-4">Add Payment / View Transactions</h2>
            <p class="text-gray-700 mb-4">For: <span id="currentMemberName" class="font-semibold"></span></p>

            <form id="transactionForm" class="space-y-4 mb-6 p-4 border rounded-md bg-gray-50">
                <h3 class="text-lg font-medium mb-2">Record New Transaction</h3>
                <input type="hidden" id="transactionMemberId">
                <input type="hidden" id="transactionId">
                <input type="hidden" id="transactionExpectedReferenceCode">

                <div>
                    <label for="transactionAmount" class="block text-gray-700 text-sm font-bold mb-2">Amount:</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="transactionReferenceCode" class="block text-gray-700 text-sm font-bold mb-2">Confirm Reference Code:</label>
                    <input type="text" id="transactionReferenceCode" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Enter member's reference code to confirm" required>
                </div>
                 <div>
                    <label for="transactionType" class="block text-gray-700 text-sm font-bold mb-2">Transaction Type:</label>
                    <select id="transactionType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="Payment">Payment</option>
                        <option value="Refund">Refund</option>
                        <option value="Adjustment">Adjustment</option>
                    </select>
                </div>
                <div>
                    <label for="transactionNotes" class="block text-gray-700 text-sm font-bold mb-2">Notes (Optional):</label>
                    <textarea id="transactionNotes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Record Transaction</button>
                </div>
            </form>

            <h3 class="text-lg font-medium mb-2">Transaction History</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                    <thead class="bg-gray-200">
                        <tr>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Type</th>
                            <th class="py-3 px-4 border-b text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Amount</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Notes</th>
                            <th class="py-3 px-4 border-b text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history-body">
                        </tbody>
                </table>
                <p id="loading-transactions" class="text-center py-4 text-gray-600 hidden">Loading transactions...</p>
                <p id="error-transactions" class="text-center py-4 text-red-500 hidden"></p>
            </div>
            <div class="flex justify-end mt-4">
                <button type="button" onclick="closeTransactionModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded">Close</button>
            </div>
        </div>
    </div>

    <div id="logout-modal" class="modal hidden">
        <div class="logout-modal-content">
            <h2>Session About to Expire!</h2>
            <p>You will be logged out in <span class="countdown" id="countdown"></span> seconds due to inactivity.</p>
            <p>Click "Stay Logged In" to continue your session.</p>
            <button id="stayLoggedInBtn">Stay Logged In</button>
        </div>
    </div>


    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Initialize Supabase Client
        // IMPORTANT: Replace with your Supabase URL and Public Key.
        // It's generally safer to use environment variables for these in production.
        const supabaseUrl = 'https://sacjuubsiixwnazxjtpp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhY2p1dWJzaWl4d25henhqdHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MjQ2MDEsImV4cCI6MjA2ODIwMDYwMX0.U9TJeh25-3eEwr2y5rSmj4Kh37HXJZdWgXeqEqPTzmo';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Supabase Authentication Check ---
        // This is crucial for verifying if the user is logged in when the page loads.
        async function checkUserSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error("Error getting session:", error.message);
                // Optionally redirect to login on error
                window.location.href = '/login.html'; // Assuming a login page
                return false;
            }
            if (!session) {
                console.log("No active session found. Redirecting to login.");
                window.location.href = '/login.html'; // Redirect to your login page
                return false;
            }
            console.log("User is logged in:", session.user.email);
            return true;
        }

        // --- DOM Elements ---
        const groupsTableBody = document.getElementById('groups-table-body');
        const loadingGroups = document.getElementById('loading-groups');
        const errorGroups = document.getElementById('error-groups');
        const addGroupButton = document.getElementById('addGroupButton');
        const logoutButton = document.getElementById('logoutButton'); // Added logout button

        const groupMembersModal = document.getElementById('groupMembersModal');
        const modalTitle = document.getElementById('modalTitle');
        const groupMembersModalBody = document.getElementById('group-members-modal-body');
        const loadingGroupMembers = document.getElementById('loading-group-members');
        const errorGroupMembers = document.getElementById('error-group-members');
        const addMemberButton = document.getElementById('addMemberButton');

        let currentGroupId = null;
        let currentMemberId = null;

        const groupFormModal = document.getElementById('groupFormModal');
        const groupFormModalTitle = document.getElementById('groupFormModalTitle');
        const groupForm = document.getElementById('groupForm');
        const groupIdInput = document.getElementById('groupId');
        const groupNameInput = document.getElementById('groupName');
        const groupReferenceCodeInput = document.getElementById('groupReferenceCode');

        const memberFormModal = document.getElementById('memberFormModal');
        const memberFormModalTitle = document.getElementById('memberFormModalTitle');
        const memberForm = document.getElementById('memberForm');
        const memberIdInput = document.getElementById('memberId');
        const memberGroupIdInput = document.getElementById('memberGroupId');
        const memberNameInput = document.getElementById('memberName');
        const memberTicketTypeInput = document.getElementById('memberTicketType');
        const memberTicketPriceInput = document.getElementById('memberTicketPrice');
        const memberQuantityInput = document.getElementById('memberQuantity');
        const memberReferenceCodeInput = document.getElementById('memberReferenceCode');

        const addTicketModal = document.getElementById('addTicketModal');
        const addTicketModalTitle = document.getElementById('addTicketModalTitle');
        const addTicketMemberNameSpan = document.getElementById('addTicketMemberName');
        const addTicketForm = document.getElementById('addTicketForm');
        const addTicketMemberIdInput = document.getElementById('addTicketMemberId');
        const addTicketCurrentQuantityInput = document.getElementById('addTicketCurrentQuantity');
        const addTicketCurrentTicketTypeInput = document.getElementById('addTicketCurrentTicketType');
        const addTicketCurrentTicketPriceInput = document.getElementById('addTicketCurrentTicketPrice');
        const addTicketExpectedReferenceCodeInput = document.getElementById('addTicketExpectedReferenceCode');
        const addTicketQuantityInput = document.getElementById('addTicketQuantity');
        const addTicketTypeInput = document.getElementById('addTicketType');
        const addTicketPriceInput = document.getElementById('addTicketPrice');
        const addTicketReferenceCodeInput = document.getElementById('addTicketReferenceCode');
        const currentTicketTypeDisplay = document.getElementById('currentTicketTypeDisplay');
        const currentTicketPriceDisplay = document.getElementById('currentTicketPriceDisplay');

        const transactionModal = document.getElementById('transactionModal');
        const transactionModalTitle = document.getElementById('transactionModalTitle');
        const currentMemberNameSpan = document.getElementById('currentMemberName');
        const transactionForm = document.getElementById('transactionForm');
        const transactionMemberIdInput = document.getElementById('transactionMemberId');
        const transactionIdInput = document.getElementById('transactionId');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionReferenceCodeInput = document.getElementById('transactionReferenceCode');
        const transactionExpectedReferenceCodeInput = document.getElementById('transactionExpectedReferenceCode');
        const transactionNotesInput = document.getElementById('transactionNotes');
        const transactionHistoryBody = document.getElementById('transaction-history-body');
        const loadingTransactions = document.getElementById('loading-transactions');
        const errorTransactions = document.getElementById('error-transactions');
        const transactionTypeInput = document.getElementById('transactionType'); // New: for transaction type dropdown

        let currentOpenDropdown = null;

        // --- Utility Functions ---

        function showLoading(element) {
            element.classList.remove('hidden');
        }

        function hideLoading(element) {
            element.classList.add('hidden');
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
        }

        // --- Auto-Logout Implementation ---
        const INACTIVITY_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes of inactivity
        const WARNING_TIME_MS = 30 * 1000;          // Show warning 30 seconds before logout
        const LOGOUT_REDIRECT_URL = 'login.html';  // Where to redirect after logout

        let inactivityTimeoutId;            // Main timer for inactivity detection
        let warningTimeoutId;               // Timer for the warning countdown
        let countdownIntervalId;            // Interval for updating the countdown display
        let countdownSeconds = WARNING_TIME_MS / 1000; // Initial countdown value

        const logoutModal = document.getElementById('logout-modal');
        const stayLoggedInButton = document.getElementById('stayLoggedInBtn');
        const countdownDisplay = document.getElementById('countdown');

        /**
         * Logs out the user via Supabase and redirects.
         */
        async function performLogout() {
            clearAllLogoutTimers();
            console.log("Logging out due to inactivity...");
            alert("You have been logged out due to inactivity.");

            // Supabase signOut
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Supabase logout error:', error.message);
            }
            window.location.href = LOGOUT_REDIRECT_URL;
        }

        /**
         * Resets the inactivity timer. Called on user activity.
         */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimeoutId);
            hideLogoutWarningModal(); // Hide modal if it was open
            startInactivityTimer(); // Restart the timer
        }

        /**
         * Starts the main inactivity timer.
         */
        function startInactivityTimer() {
            inactivityTimeoutId = setTimeout(() => {
                showLogoutWarningModal(); // Show warning before actual logout
            }, INACTIVITY_TIMEOUT_MS - WARNING_TIME_MS);
        }

        /**
         * Displays the logout warning modal and starts its countdown.
         */
        function showLogoutWarningModal() {
            console.log("Showing logout warning...");
            logoutModal.style.display = 'flex'; // Use flex to center
            countdownSeconds = WARNING_TIME_MS / 1000; // Reset countdown
            updateCountdownDisplay(); // Initial display

            warningTimeoutId = setTimeout(performLogout, WARNING_TIME_MS);
            countdownIntervalId = setInterval(updateCountdownDisplay, 1000);
        }

        /**
         * Hides the logout warning modal and clears its related timers.
         */
        function hideLogoutWarningModal() {
            logoutModal.style.display = 'none';
            clearTimeout(warningTimeoutId);
            clearInterval(countdownIntervalId);
        }

        /**
         * Updates the countdown display in the modal.
         */
        function updateCountdownDisplay() {
            countdownDisplay.textContent = countdownSeconds;
            if (countdownSeconds <= 0) {
                clearInterval(countdownIntervalId);
            }
            countdownSeconds--;
        }

        /**
         * Clears all timers related to inactivity and warning.
         */
        function clearAllLogoutTimers() {
            clearTimeout(inactivityTimeoutId);
            clearTimeout(warningTimeoutId);
            clearInterval(countdownIntervalId);
        }

        // --- Global Activity Listeners for Logout Timer ---
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);

        // --- Event Listener for "Stay Logged In" button ---
        stayLoggedInButton.addEventListener('click', () => {
            resetInactivityTimer(); // Reset all timers and hide modal
        });

        // Event listener for the manual Logout button
        logoutButton.addEventListener('click', async () => {
            if (confirm("Are you sure you want to log out?")) {
                await performLogout();
            }
        });

        // --- Group Management Functions ---

        async function fetchGroups() {
            showLoading(loadingGroups);
            hideError(errorGroups);
            groupsTableBody.innerHTML = ''; // Clear existing data

            try {
                const { data, error } = await supabase
                    .from('groups')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    groupsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No groups found. Click "Add New Group" to create one.</td></tr>`;
                } else {
                    data.forEach(group => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="uuid-cell">${group.id}</td>
                            <td>${group.name}</td>
                            <td class="code-cell">${group.reference_code || 'N/A'}</td>
                            <td class="timestamp-cell">${new Date(group.created_at).toLocaleString()}</td>
                            <td class="action-buttons">
                                <button class="edit-button bg-yellow-500 hover:bg-yellow-600 text-white p-2 rounded-full text-xs" data-id="${group.id}" title="Edit Group">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-full text-xs ml-1" data-id="${group.id}" data-name="${group.name}" title="Delete Group">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        // Add click event listeners to non-action cells to view members
                        row.querySelectorAll('td:not(.action-buttons)').forEach(cell => {
                            cell.addEventListener('click', () => showGroupMembersInGroup(group.id, group.name));
                        });

                        row.querySelector('.edit-button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            openGroupFormModalForEdit(group);
                        });
                        row.querySelector('.delete-button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteGroup(group.id, group.name);
                        });

                        groupsTableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching groups:', error.message);
                showError(errorGroups, `Failed to load groups: ${error.message}. Please check your Supabase configuration and RLS policies.`);
                groupsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading groups.</td></tr>`;
            } finally {
                hideLoading(loadingGroups);
            }
        }

        // Event listener for opening the Add Group modal
        addGroupButton.addEventListener('click', () => {
            groupFormModalTitle.textContent = 'Add New Group';
            groupForm.reset();
            groupIdInput.value = '';
            groupFormModal.classList.remove('hidden');
        });

        function openGroupFormModalForEdit(group) {
            groupFormModalTitle.textContent = 'Edit Group';
            groupIdInput.value = group.id;
            groupNameInput.value = group.name;
            groupReferenceCodeInput.value = group.reference_code || '';
            groupFormModal.classList.remove('hidden');
        }

        function closeGroupFormModal() {
            groupFormModal.classList.add('hidden');
        }

        groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = groupIdInput.value;
            const name = groupNameInput.value;
            const reference_code = groupReferenceCodeInput.value || null;

            if (!name.trim()) {
                alert('Please enter a group name.');
                return;
            }

            try {
                if (id) {
                    const { error } = await supabase
                        .from('groups')
                        .update({ name, reference_code })
                        .eq('id', id);
                    if (error) throw error;
                    alert('Group updated successfully!');
                } else {
                    const { error } = await supabase
                        .from('groups')
                        .insert({ name, reference_code });
                    if (error) throw error;
                    alert('Group added successfully!');
                }
                closeGroupFormModal();
                fetchGroups();
            } catch (error) {
                console.error('Error saving group:', error.message);
                alert(`Error saving group: ${error.message}`);
            }
        });

        async function deleteGroup(id, name) {
            if (!confirm(`Are you sure you want to delete the group "${name}"? This will also delete all associated members and their transactions.`)) {
                return;
            }

            try {
                // Supabase typically handles CASCADE DELETE if configured in your database schema.
                // If not, you'd manually delete members and then transactions for those members.
                // For simplicity, assuming ON DELETE CASCADE is set up on group_members and transactions tables
                // for group_id and member_id respectively.

                const { error: groupError } = await supabase
                    .from('groups')
                    .delete()
                    .eq('id', id);

                if (groupError) throw groupError;

                alert('Group and its associated data deleted successfully!');
                fetchGroups();
            } catch (error) {
                console.error('Error deleting group:', error.message);
                alert(`Error deleting group: ${error.message}`);
            }
        }

        // --- Group Member Management Functions ---

        addMemberButton.addEventListener('click', () => {
            if (!currentGroupId) {
                alert('Error: No group selected to add a member to.');
                return;
            }
            memberFormModalTitle.textContent = 'Add New Member';
            memberForm.reset();
            memberIdInput.value = '';
            memberGroupIdInput.value = currentGroupId;
            memberNameInput.focus(); // Focus on the first input
            memberFormModal.classList.remove('hidden');
        });

        async function showGroupMembersInGroup(groupId, groupName) {
            currentGroupId = groupId;
            groupMembersModal.classList.remove('hidden');
            modalTitle.textContent = `Group Members in Group: ${groupName}`;
            showLoading(loadingGroupMembers);
            hideError(errorGroupMembers);
            groupMembersModalBody.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('group_members')
                    .select(`
                        id,
                        name,
                        ticket_type,
                        ticket_price,
                        quantity,
                        reference_code,
                        group_id,
                        transactions(
                            amount,
                            transaction_type
                        )
                    `)
                    .eq('group_id', groupId)
                    .order('name', { ascending: true });

                if (error) throw error;

                const COLSPAN_COUNT = 10;

                if (data.length === 0) {
                    groupMembersModalBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-gray-500">No members found in this group. Click "Add New Member" to add one.</td></tr>`;
                } else {
                    data.forEach(member => {
                        const totalDue = (parseFloat(member.ticket_price) * parseInt(member.quantity));
                        const totalPaid = member.transactions.reduce((sum, transaction) => {
                            return sum + (transaction.transaction_type === 'Payment' ? parseFloat(transaction.amount) : 0);
                        }, 0);
                        const balanceDue = totalDue - totalPaid;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="uuid-cell">${member.id}</td>
                            <td>${member.name}</td>
                            <td>${member.ticket_type || 'N/A'}</td>
                            <td class="numeric-cell">$${parseFloat(member.ticket_price).toFixed(2)}</td>
                            <td class="numeric-cell">${member.quantity}</td>
                            <td class="numeric-cell font-bold text-blue-700">$${totalDue.toFixed(2)}</td>
                            <td class="numeric-cell font-bold text-green-700">$${totalPaid.toFixed(2)}</td>
                            <td class="numeric-cell font-bold ${balanceDue > 0 ? 'text-red-700' : 'text-gray-700'}">$${balanceDue.toFixed(2)}</td>
                            <td class="code-cell">${member.reference_code || 'N/A'}</td>
                            <td class="action-buttons">
                                <div class="dropdown-container">
                                    <button class="kebab-button" data-member-id="${member.id}" title="More Actions">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu" id="dropdown-${member.id}">
                                        <button class="edit-action" data-action="edit">
                                            <i class="fas fa-edit"></i> Edit Member
                                        </button>
                                        <button class="payment-action" data-action="payment">
                                            <i class="fas fa-money-bill-wave"></i> Add Payment / View Transactions
                                        </button>
                                        <button class="ticket-action" data-action="add-ticket">
                                            <i class="fas fa-ticket-alt"></i> Add More Tickets
                                        </button>
                                        <button class="delete-action" data-action="delete">
                                            <i class="fas fa-trash-alt"></i> Delete Member
                                        </button>
                                    </div>
                                </div>
                            </td>
                        `;

                        const kebabButton = row.querySelector('.kebab-button');
                        kebabButton.memberData = member; // Attach the full member object

                        kebabButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleMemberActionsDropdown(e.currentTarget);
                        });

                        const dropdownMenu = row.querySelector('.dropdown-menu');
                        dropdownMenu.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const actionButton = e.target.closest('button');
                            if (actionButton) {
                                const action = actionButton.dataset.action;
                                const memberToActOn = kebabButton.memberData;

                                closeAllDropdowns();

                                if (!memberToActOn) {
                                    alert('Error: Member data not found for action. Please try again.');
                                    return;
                                }

                                switch (action) {
                                    case 'edit':
                                        openMemberFormModalForEdit(memberToActOn);
                                        break;
                                    case 'payment':
                                        showTransactionsForMember(memberToActOn.id, memberToActOn.name, memberToActOn.reference_code);
                                        break;
                                    case 'add-ticket':
                                        openAddTicketModal(memberToActOn);
                                        break;
                                    case 'delete':
                                        deleteMember(memberToActOn.id, memberToActOn.name);
                                        break;
                                    default:
                                        console.warn('Unknown action:', action);
                                }
                            }
                        });
                        groupMembersModalBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching group members:', error.message);
                showError(errorGroupMembers, `Failed to load group members: ${error.message}.`);
                groupMembersModalBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-red-500">Error loading group members.</td></tr>`;
            } finally {
                hideLoading(loadingGroupMembers);
            }
        }

        function closeGroupMembersModal() {
            groupMembersModal.classList.add('hidden');
            currentGroupId = null;
            closeAllDropdowns();
        }

        function openMemberFormModalForEdit(member) {
            memberFormModalTitle.textContent = 'Edit Member';
            memberIdInput.value = member.id;
            memberGroupIdInput.value = member.group_id;
            memberNameInput.value = member.name;
            memberTicketTypeInput.value = member.ticket_type || '';
            memberTicketPriceInput.value = member.ticket_price;
            memberQuantityInput.value = member.quantity;
            memberReferenceCodeInput.value = member.reference_code || '';
            memberFormModal.classList.remove('hidden');
        }

        function closeMemberFormModal() {
            memberFormModal.classList.add('hidden');
        }

        memberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = memberIdInput.value;
            const group_id = memberGroupIdInput.value;
            const name = memberNameInput.value;
            const ticket_type = memberTicketTypeInput.value;
            const ticket_price = parseFloat(memberTicketPriceInput.value);
            const quantity = parseInt(memberQuantityInput.value);
            const reference_code = memberReferenceCodeInput.value || null;

            if (isNaN(ticket_price) || ticket_price < 0) {
                alert('Please enter a valid ticket price (a non-negative number).');
                return;
            }
            if (isNaN(quantity) || quantity < 1) {
                alert('Please enter a valid quantity (minimum 1).');
                return;
            }
            if (!ticket_type) {
                alert('Please select a ticket type.');
                return;
            }
            if (!name.trim()) {
                alert('Please enter a member name.');
                return;
            }
            try {
                if (id) {
                    const { error } = await supabase
                        .from('group_members')
                        .update({ name, ticket_type, ticket_price, quantity, reference_code })
                        .eq('id', id);
                    if (error) throw error;
                    alert('Member updated successfully!');
                } else {
                    const { error } = await supabase
                        .from('group_members')
                        .insert({ group_id, name, ticket_type, ticket_price, quantity, reference_code });
                    if (error) throw error;
                    alert('Member added successfully!');
                }
                closeMemberFormModal();

                if (group_id && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(group_id, groupNameMatch[1]);
                    } else {
                        console.warn('Could not extract group name from modal title. Refreshing all groups.');
                        fetchGroups();
                    }
                } else {
                    fetchGroups();
                }

            } catch (error) {
                console.error('Error saving member:', error.message);
                alert(`Error saving member: ${error.message}`);
            }
        });

        async function deleteMember(id, name) {
            if (!confirm(`Are you sure you want to delete the member "${name}"? This will also delete all associated transactions.`)) {
                return;
            }

            try {
                // Assuming ON DELETE CASCADE is set up on the 'transactions' table to delete related transactions.
                const { error } = await supabase
                    .from('group_members')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Member and its transactions deleted successfully!');
                if (currentGroupId && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(currentGroupId, groupNameMatch[1]);
                    } else {
                        fetchGroups();
                    }
                } else {
                    fetchGroups();
                }

            } catch (error) {
                console.error('Error deleting member:', error.message);
                alert(`Error deleting member: ${error.message}`);
            }
        }

        // --- Add Ticket Functions ---
        function openAddTicketModal(member) {
            addTicketModalTitle.textContent = `Add Tickets for: ${member.name}`;
            addTicketMemberNameSpan.textContent = member.name;
            addTicketMemberIdInput.value = member.id;
            addTicketCurrentQuantityInput.value = member.quantity;
            addTicketCurrentTicketTypeInput.value = member.ticket_type;
            addTicketCurrentTicketPriceInput.value = member.ticket_price;
            addTicketExpectedReferenceCodeInput.value = member.reference_code || '';
            currentTicketTypeDisplay.textContent = member.ticket_type || 'N/A';
            currentTicketPriceDisplay.textContent = parseFloat(member.ticket_price).toFixed(2);
            addTicketForm.reset();
            addTicketQuantityInput.value = '1';
            addTicketTypeInput.value = '';
            addTicketPriceInput.value = ''; // Clear new ticket price input
            addTicketReferenceCodeInput.value = ''; // Clear confirmation ref code
            addTicketModal.classList.remove('hidden');
        }

        function closeAddTicketModal() {
            addTicketModal.classList.add('hidden');
        }

        addTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = addTicketMemberIdInput.value;
            const currentQuantity = parseInt(addTicketCurrentQuantityInput.value);
            const currentTicketType = addTicketCurrentTicketTypeInput.value;
            const currentTicketPrice = parseFloat(addTicketCurrentTicketPriceInput.value);
            const expectedRefCode = addTicketExpectedReferenceCodeInput.value;
            const userRefCode = addTicketReferenceCodeInput.value.trim();

            if (expectedRefCode === null || expectedRefCode === "") {
                alert('Error: This member does not have a reference code. Cannot proceed with this action. Please edit the member and add a reference code first.');
                return;
            }
            if (userRefCode !== expectedRefCode) {
                alert('Error: The provided reference code does not match the member\'s reference code. Please try again.');
                return;
            }

            const quantityToAdd = parseInt(addTicketQuantityInput.value);
            const newTicketType = addTicketTypeInput.value.trim();
            const newTicketPriceInputVal = addTicketPriceInput.value.trim();
            const newTicketPrice = newTicketPriceInputVal === '' ? currentTicketPrice : parseFloat(newTicketPriceInputVal); // Default to current price if empty

            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                alert('Please enter a valid number of tickets to add (minimum 1).');
                return;
            }
            if (newTicketType && (isNaN(newTicketPrice) || newTicketPrice < 0)) {
                alert('Please enter a valid price for the new ticket type.');
                return;
            }
            if (!newTicketType && newTicketPriceInputVal !== '' && (isNaN(newTicketPrice) || newTicketPrice < 0)) {
                 alert('Please enter a valid price for the ticket price update.');
                 return;
            }


            let updatedQuantity;
            let finalTicketType;
            let finalTicketPrice;
            let transactionAmount = 0;
            let transactionNotes = '';
            let transactionType = 'Adjustment'; // Default transaction type for ticket changes

            if (newTicketType) {
                // If a new ticket type is specified, it becomes the primary, and quantityToAdd is the new total quantity.
                finalTicketType = newTicketType;
                finalTicketPrice = newTicketPrice;
                updatedQuantity = quantityToAdd; // This is now the *new total quantity* for the new type
                transactionAmount = quantityToAdd * finalTicketPrice; // Amount based on the new tickets
                transactionNotes = `Changed primary ticket type to ${finalTicketType} and added ${quantityToAdd} tickets @ $${finalTicketPrice.toFixed(2)} each.`;
            } else {
                // Just adding more of the existing ticket type
                finalTicketType = currentTicketType;
                finalTicketPrice = currentTicketPrice; // Keep existing price
                updatedQuantity = currentQuantity + quantityToAdd;
                transactionAmount = quantityToAdd * currentTicketPrice; // Amount based on adding more existing tickets
                transactionNotes = `Added ${quantityToAdd} more ${currentTicketType} tickets @ $${currentTicketPrice.toFixed(2)} each.`;
            }

            // Handle potential price-only update (without changing type or adding quantity in the primary sense)
            if (!newTicketType && newTicketPriceInputVal !== '' && newTicketPrice !== currentTicketPrice) {
                finalTicketPrice = newTicketPrice;
                // If only price changed, but no new quantity added, transaction amount is 0, notes reflect price update
                if (quantityToAdd === 0 || isNaN(quantityToAdd)) { // If quantity was not explicitly increased
                    transactionAmount = 0;
                    transactionNotes = `Updated price for ${finalTicketType} tickets to $${finalTicketPrice.toFixed(2)}. Quantity remains ${updatedQuantity || currentQuantity}.`;
                } else { // If price changed AND quantity added
                     transactionNotes = `Added ${quantityToAdd} ${finalTicketType} tickets at new price $${finalTicketPrice.toFixed(2)}. Total tickets: ${updatedQuantity}.`;
                }
            }


            try {
                // Update member's ticket details
                const { error: memberUpdateError } = await supabase
                    .from('group_members')
                    .update({
                        quantity: updatedQuantity,
                        ticket_type: finalTicketType,
                        ticket_price: finalTicketPrice
                    })
                    .eq('id', memberId);

                if (memberUpdateError) throw memberUpdateError;

                // Record the transaction for the ticket change
                if (transactionAmount > 0 || transactionNotes) { // Only add transaction if there's an amount or specific notes
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert({
                            member_id: memberId,
                            amount: transactionAmount,
                            transaction_type: transactionType,
                            reference_code: userRefCode, // Store the confirmed reference code
                            notes: transactionNotes
                        });

                    if (transactionError) {
                        console.warn('Warning: Failed to record transaction for ticket update:', transactionError.message);
                    }
                }

                alert('Tickets updated successfully!');
                closeAddTicketModal();
                // Refresh the group members modal to show updated values
                if (currentGroupId && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(currentGroupId, groupNameMatch[1]);
                    }
                } else {
                    fetchGroups(); // Fallback to refreshing all groups
                }

            } catch (error) {
                console.error('Error updating tickets or member:', error.message);
                alert(`Error updating tickets or member: ${error.message}`);
            }
        });


        // --- Transaction Functions ---

        async function showTransactionsForMember(memberId, memberName, memberRefCode) {
            currentMemberId = memberId;
            transactionModal.classList.remove('hidden');
            transactionModalTitle.textContent = `Transactions for: ${memberName}`;
            currentMemberNameSpan.textContent = memberName;
            transactionMemberIdInput.value = memberId;
            transactionExpectedReferenceCodeInput.value = memberRefCode || ''; // Store member's ref code
            transactionForm.reset();
            transactionReferenceCodeInput.value = ''; // Clear user input field

            showLoading(loadingTransactions);
            hideError(errorTransactions);
            transactionHistoryBody.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('member_id', memberId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    transactionHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No transactions for this member.</td></tr>`;
                } else {
                    data.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="timestamp-cell">${new Date(transaction.created_at).toLocaleString()}</td>
                            <td>${transaction.transaction_type}</td>
                            <td class="numeric-cell">$${parseFloat(transaction.amount).toFixed(2)}</td>
                            <td>${transaction.notes || 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="delete-transaction-button bg-red-500 hover:bg-red-600 text-white p-2 rounded-full text-xs" data-id="${transaction.id}" title="Delete Transaction">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        row.querySelector('.delete-transaction-button').addEventListener('click', (e) => {
                            deleteTransaction(transaction.id, memberId, memberName, memberRefCode);
                        });
                        transactionHistoryBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching transactions:', error.message);
                showError(errorTransactions, `Failed to load transactions: ${error.message}.`);
                transactionHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-red-500">Error loading transactions.</td></tr>`;
            } finally {
                hideLoading(loadingTransactions);
            }
        }

        function closeTransactionModal() {
            transactionModal.classList.add('hidden');
            currentMemberId = null;
        }

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = transactionMemberIdInput.value;
            const amount = parseFloat(transactionAmountInput.value);
            const userRefCode = transactionReferenceCodeInput.value.trim();
            const expectedRefCode = transactionExpectedReferenceCodeInput.value;
            const notes = transactionNotesInput.value || null;
            const transactionType = transactionTypeInput.value; // Get selected transaction type

            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount for the transaction.');
                return;
            }
            if (expectedRefCode === null || expectedRefCode === "") {
                alert('Error: This member does not have a reference code. Cannot record transaction. Please edit the member and add a reference code first.');
                return;
            }
            if (userRefCode !== expectedRefCode) {
                alert('Error: The provided reference code does not match the member\'s reference code. Please try again.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('transactions')
                    .insert({
                        member_id: memberId,
                        amount: amount,
                        transaction_type: transactionType,
                        reference_code: userRefCode, // Store the confirmed reference code
                        notes: notes
                    });

                if (error) throw error;

                alert('Transaction recorded successfully!');
                transactionForm.reset();
                transactionReferenceCodeInput.value = ''; // Clear user input field

                // Re-fetch transactions and also refresh member list to update balance
                const memberName = currentMemberNameSpan.textContent;
                const memberRefCode = transactionExpectedReferenceCodeInput.value;
                showTransactionsForMember(memberId, memberName, memberRefCode); // Refresh transaction history
                if (currentGroupId && modalTitle.textContent) {
                     const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                     if (groupNameMatch && groupNameMatch[1]) {
                         showGroupMembersInGroup(currentGroupId, groupNameMatch[1]); // Refresh member list
                     }
                }
            } catch (error) {
                console.error('Error recording transaction:', error.message);
                alert(`Error recording transaction: ${error.message}`);
            }
        });

        async function deleteTransaction(transactionId, memberId, memberName, memberRefCode) {
            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('transactions')
                    .delete()
                    .eq('id', transactionId);

                if (error) throw error;

                alert('Transaction deleted successfully!');
                showTransactionsForMember(memberId, memberName, memberRefCode); // Refresh transaction history
                if (currentGroupId && modalTitle.textContent) {
                     const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                     if (groupNameMatch && groupNameMatch[1]) {
                         showGroupMembersInGroup(currentGroupId, groupNameMatch[1]); // Refresh member list
                     }
                }
            } catch (error) {
                console.error('Error deleting transaction:', error.message);
                alert(`Error deleting transaction: ${error.message}`);
            }
        }


        // --- Dropdown Management ---

        function toggleMemberActionsDropdown(button) {
            const dropdownMenu = button.nextElementSibling; // The dropdown is the next sibling
            if (currentOpenDropdown && currentOpenDropdown !== dropdownMenu) {
                currentOpenDropdown.style.display = 'none'; // Close other open dropdown
            }
            dropdownMenu.style.display = dropdownMenu.style.display === 'block' ? 'none' : 'block';
            currentOpenDropdown = dropdownMenu.style.display === 'block' ? dropdownMenu : null;
        }

        // Close dropdown if clicked outside
        document.addEventListener('click', (e) => {
            if (currentOpenDropdown && !e.target.closest('.dropdown-container')) {
                closeAllDropdowns();
            }
        });

        function closeAllDropdowns() {
            if (currentOpenDropdown) {
                currentOpenDropdown.style.display = 'none';
                currentOpenDropdown = null;
            }
        }

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // First, check if the user is authenticated.
            const isAuthenticated = await checkUserSession();
            if (isAuthenticated) {
                // Only fetch data and start timers if the user is logged in.
                fetchGroups();
                startInactivityTimer();
                console.log("Automatic logout timer started.");
            }
        });

    </script>
</body>
</html>