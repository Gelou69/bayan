<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       /* --- Color Palette Variables --- */
:root {
    --primary-color: #4A6572; /* Dark Teal */
    --primary-light: #6B8E99;
    --primary-dark: #344955;

    --secondary-color: #F9AA33; /* Orange */
    --secondary-light: #FFC166;
    --secondary-dark: #D48A1F;

    --accent-color: #28B463; /* Green for success/add */
    --accent-light: #58D68D;
    --accent-dark: #1F8D4F;

    --danger-color: #E74C3C; /* Red for danger/delete */
    --danger-light: #EC7063;
    --danger-dark: #C0392B;

    --neutral-light: #F8F9FA; /* Light Gray Background */
    --neutral-medium: #E9ECEF; /* Medium Gray */
    --neutral-dark: #CED4DA; /* Darker Gray for borders */
    --text-color: #343A40; /* Dark text */
    --text-light: #6C757D; /* Lighter text */
}

/* --- Global Styles --- */
body {
    font-family: 'Inter', 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background-color: var(--neutral-light);
    color: var(--text-color);
}

/* --- Modal Styles --- */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* Darker backdrop */
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
    opacity: 0;
    transition: opacity 0.4s ease-in-out;
}
.modal.show {
    opacity: 1;
    display: flex;
}
.modal-content {
    background-color: white;
    padding: 2.5rem;
    border-radius: 0.75rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
    max-width: 90%;
    max-height: 90%;
    overflow-y: auto;
    transform: translateY(-30px);
    transition: transform 0.4s ease-in-out;
    position: relative;
}
.modal.show .modal-content {
    transform: translateY(0);
}

.modal-close-button {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: none;
    border: none;
    font-size: 1.75rem;
    color: var(--text-light);
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
    padding: 0.25rem;
}
.modal-close-button:hover {
    color: var(--danger-color);
    transform: scale(1.3) rotate(90deg);
}

/* --- Dropdown Styles --- */
.dropdown-container {
    position: relative;
    display: inline-block;
}
.dropdown-menu {
    position: absolute;
    right: 0;
    background-color: white;
    border: 1px solid var(--neutral-dark);
    border-radius: 0.5rem;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    z-index: 50;
    min-width: 200px;
    display: none;
    opacity: 0;
    transform: translateY(15px);
    transition: opacity 0.3s ease-out, transform 0.3s ease-out;
}
.dropdown-menu.show {
    display: block;
    opacity: 1;
    transform: translateY(0);
}
.dropdown-menu button {
    display: flex;
    align-items: center;
    width: 100%;
    padding: 0.75rem 1.25rem;
    text-align: left;
    background: none;
    border: none;
    cursor: pointer;
    font-size: 0.95rem;
    color: var(--text-color);
    transition: background-color 0.2s ease, color 0.2s ease, transform 0.1s ease;
}
.dropdown-menu button i {
    margin-right: 0.75rem;
    width: 1.25rem;
    text-align: center;
}
.dropdown-menu button:hover {
    background-color: var(--neutral-medium);
    color: var(--primary-dark);
    transform: translateX(5px);
}

/* --- Table Styles --- */
table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
}
thead {
    background-color: var(--primary-light);
    color: white;
}
th {
    padding: 1rem 1.25rem;
    text-align: left;
    font-size: 0.85rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-bottom: 2px solid var(--primary-dark);
}
tbody tr {
    background-color: white;
    transition: background-color 0.2s ease, transform 0.1s ease;
}
tbody tr:nth-child(even) {
    background-color: var(--neutral-light);
}
tbody tr:hover {
    background-color: var(--neutral-medium);
    transform: scale(1.005);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}
td {
    padding: 0.9rem 1.25rem;
    border-bottom: 1px solid var(--neutral-medium);
    font-size: 0.95rem;
}
tbody tr:last-child td {
    border-bottom: none;
}

/* --- Action Buttons --- */
.kebab-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2em;
    color: var(--primary-color);
    padding: 0.5rem;
    border-radius: 50%;
    transition: color 0.2s ease, transform 0.2s ease, background-color 0.2s ease;
}
.kebab-button:hover {
    color: var(--primary-dark);
    background-color: var(--neutral-medium);
    transform: scale(1.2) rotate(90deg);
}

/* --- Button Styles --- */
.btn {
    font-weight: 700;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    transition: all 0.2s ease-in-out;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border: none;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
.btn i {
    margin-right: 0.5rem;
}

.btn-primary {
    background-color: var(--primary-color);
    color: white;
}
.btn-primary:hover {
    background-color: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-secondary {
    background-color: var(--secondary-color);
    color: white;
}
.btn-secondary:hover {
    background-color: var(--secondary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-accent {
    background-color: var(--accent-color);
    color: white;
}
.btn-accent:hover {
    background-color: var(--accent-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-danger {
    background-color: var(--danger-color);
    color: white;
}
.btn-danger:hover {
    background-color: var(--danger-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

.btn-neutral {
    background-color: var(--neutral-medium);
    color: var(--text-color);
}
.btn-neutral:hover {
    background-color: var(--neutral-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
}

/* --- Header & Navbar --- */
.header {
    background-color: var(--primary-color);
    padding: 1rem 2rem;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    position: sticky;
    top: 0;
    z-index: 1000;
}
.navbar {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    background-color: var(--primary-color);
    color: white;
}
.navbar a,
.navbar button {
    color: white;
    font-size: 1rem;
    margin-left: 1.5rem;
    text-decoration: none;
    cursor: pointer;
    transition: color 0.2s ease, transform 0.2s ease;
}
.navbar a:hover,
.navbar button:hover {
    color: var(--secondary-color);
    transform: translateY(-2px);
}

/* --- Search Bar --- */
.search-container {
    display: flex;
    justify-content: space-between;
    margin-top: 2rem;
}
.search-input {
    width: 100%;
    padding: 0.75rem 1.5rem;
    font-size: 1rem;
    border: 1px solid var(--neutral-dark);
    border-radius: 0.75rem;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
}
.search-input:focus {
    box-shadow: 0 0 0 4px var(--accent-light);
    border-color: var(--accent-color);
}
.search-input::placeholder {
    color: var(--text-light);
}
.search-icon {
    font-size: 1.2rem;
    margin-right: 1rem;
    color: var(--primary-dark);
    transition: color 0.2s ease;
}
.search-icon:hover {
    color: var(--accent-color);
}

    </style>
</head>
<body class="p-8">
     <nav class="header">
        <div class="navbar">
            <a href="profile.html"><span>Home</span></a>
            <a href="groups.html"><span>Groups</span></a>
            <a href="person.html"><span>Persons</span></a>
            <button id="logout-button-nav"><span>Logout</span></button>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto bg-white p-8 rounded-lg shadow-lg mt-8">
        <h1 class="text-3xl font-extrabold mb-6 text-gray-800">Group Management Dashboard</h1>

        <div class="mb-8 flex flex-wrap items-center gap-4">
            <button id="addGroupButton" class="btn btn-primary">
                <i class="fas fa-plus-circle mr-2"></i>Add New Group
            </button>
            <button id="logoutButton" class="btn btn-danger">
                <i class="fas fa-sign-out-alt mr-2"></i>Logout
            </button>
        </div>

        <div class="search-container">
            <input type="text" id="memberSearchInput" class="search-input" placeholder="Search members by name or reference code...">
            <div id="searchResults" class="search-results hidden"></div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr>
                        <th class="py-3 px-4">ID</th>
                        <th class="py-3 px-4">Group Name</th>
                        <th class="py-3 px-4">Reference Code</th>
                        <th class="py-3 px-4">Created At</th>
                        <th class="py-3 px-4">Actions</th>
                    </tr>
                </thead>
                <tbody id="groups-table-body">
                    </tbody>
            </table>
            <p id="loading-groups" class="text-center py-4 hidden">Loading groups...</p>
            <p id="error-groups" class="text-center py-4 hidden"></p>
        </div>
    </div>

    <div id="groupFormModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('groupFormModal')"><i class="fas fa-times"></i></button>
            <h2 id="groupFormModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Add New Group</h2>
            <form id="groupForm" class="space-y-5">
                <input type="hidden" id="groupId">
                <div>
                    <label for="groupName" class="block text-sm font-bold mb-2">Group Name:</label>
                    <input type="text" id="groupName" class="shadow-sm" required>
                </div>
                <div>
                    <label for="groupReferenceCode" class="block text-sm font-bold mb-2">Reference Code (Optional):</label>
                    <input type="text" id="groupReferenceCode" class="shadow-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('groupFormModal')" class="btn btn-neutral">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Group</button>
                </div>
            </form>
        </div>
    </div>

    <div id="groupMembersModal" class="modal">
        <div class="modal-content w-full max-w-5xl">
            <button class="modal-close-button" onclick="closeModal('groupMembersModal')"><i class="fas fa-times"></i></button>
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">Group Members</h2>
            <div class="mb-6">
                <button id="addMemberButton" class="btn btn-accent">
                    <i class="fas fa-user-plus mr-2"></i>Add New Member
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="py-3 px-4">Name</th>
                            <th class="py-3 px-4">Ticket Type</th>
                            <th class="py-3 px-4 text-right">Price</th>
                            <th class="py-3 px-4 text-right">Qty</th>
                            <th class="py-3 px-4 text-right">Total Due</th>
                            <th class="py-3 px-4 text-right">Amount Paid</th>
                            <th class="py-3 px-4 text-right">Balance Due</th>
                            <th class="py-3 px-4">Reference Code</th>
                            <th class="py-3 px-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="group-members-modal-body">
                        </tbody>
                </table>
                <p id="loading-group-members" class="text-center py-4 hidden">Loading members...</p>
                <p id="error-group-members" class="text-center py-4 hidden"></p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeModal('groupMembersModal')" class="btn btn-neutral">Close</button>
            </div>
        </div>
    </div>

    <div id="memberFormModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('memberFormModal')"><i class="fas fa-times"></i></button>
            <h2 id="memberFormModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Add New Member</h2>
            <form id="memberForm" class="space-y-5">
                <input type="hidden" id="memberId">
                <input type="hidden" id="memberGroupId">
                <div>
                    <label for="memberName" class="block text-sm font-bold mb-2">Member Name:</label>
                    <input type="text" id="memberName" class="shadow-sm" required>
                </div>
                <div>
                    <label for="memberTicketType" class="block text-sm font-bold mb-2">Ticket Type:</label>
                    <select id="memberTicketType" class="shadow-sm" required>
                        <option value="">Select a Ticket Type</option>
                        <option value="Regular">Regular</option>
                        <option value="VIP">VIP</option>
                        <option value="Early Bird">Early Bird</option>
                        <option value="Student">Student</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="memberTicketPrice" class="block text-sm font-bold mb-2">Ticket Price:</label>
                    <input type="number" id="memberTicketPrice" step="0.01" min="0" class="shadow-sm" required>
                </div>
                <div>
                    <label for="memberQuantity" class="block text-sm font-bold mb-2">Quantity:</label>
                    <input type="number" id="memberQuantity" min="1" class="shadow-sm" required>
                </div>
                <div>
                    <label for="memberReferenceCode" class="block text-sm font-bold mb-2">Reference Code (Optional):</label>
                    <input type="text" id="memberReferenceCode" class="shadow-sm">
                </div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('memberFormModal')" class="btn btn-neutral">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Member</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addTicketModal" class="modal">
        <div class="modal-content">
            <button class="modal-close-button" onclick="closeModal('addTicketModal')"><i class="fas fa-times"></i></button>
            <h2 id="addTicketModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Add Tickets</h2>
            <p class="text-gray-700 mb-4">For: <span id="addTicketMemberName" class="font-semibold text-primary-dark"></span></p>
            <form id="addTicketForm" class="space-y-5">
                <input type="hidden" id="addTicketMemberId">
                <input type="hidden" id="addTicketCurrentQuantity">
                <input type="hidden" id="addTicketCurrentTicketType">
                <input type="hidden" id="addTicketCurrentTicketPrice">
                <input type="hidden" id="addTicketExpectedReferenceCode">
                <div class="bg-primary-light bg-opacity-10 p-4 rounded-md mb-4 text-sm text-primary-dark border border-primary-light">
                    <p>Current Ticket: <span id="currentTicketTypeDisplay" class="font-bold"></span> @ ₱<span id="currentTicketPriceDisplay" class="font-bold"></span></p>
                </div>

                <div>
                    <label for="addTicketQuantity" class="block text-sm font-bold mb-2">Quantity to Add:</label>
                    <input type="number" id="addTicketQuantity" min="1" value="1" class="shadow-sm" required>
                </div>
                <div class="text-sm text-text-light italic mt-2 mb-4">
                    Leave "New Ticket Type" and "New Ticket Price" blank to just add more of the current ticket type.
                </div>
                <div>
                    <label for="addTicketType" class="block text-sm font-bold mb-2">New Ticket Type (Optional, to change primary type):</label>
                    <select id="addTicketType" class="shadow-sm">
                        <option value="">-- No Change --</option>
                        <option value="Regular">Regular</option>
                        <option value="VIP">VIP</option>
                        <option value="Early Bird">Early Bird</option>
                        <option value="Student">Student</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div>
                    <label for="addTicketPrice" class="block text-sm font-bold mb-2">New Ticket Price (Optional, if new type or price change):</label>
                    <input type="number" id="addTicketPrice" step="0.01" min="0" class="shadow-sm">
                </div>
                <div>
                    <label for="addTicketReferenceCode" class="block text-sm font-bold mb-2">Confirm Reference Code:</label>
                    <input type="text" id="addTicketReferenceCode" class="shadow-sm" placeholder="Enter member's reference code to confirm" required>
                </div>

                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" onclick="closeModal('addTicketModal')" class="btn btn-neutral">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Tickets</button>
                </div>
            </form>
        </div>
    </div>

    <div id="transactionModal" class="modal">
        <div class="modal-content w-full max-w-xl">
            <button class="modal-close-button" onclick="closeModal('transactionModal')"><i class="fas fa-times"></i></button>
            <h2 id="transactionModalTitle" class="text-2xl font-bold mb-6 text-gray-800">Add Payment / View Transactions</h2>
            <p class="text-gray-700 mb-4">For: <span id="currentMemberName" class="font-semibold text-primary-dark"></span></p>

            <form id="transactionForm" class="space-y-5 mb-8 p-6 border border-neutral-dark rounded-lg bg-neutral-light shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-primary-dark">Record New Transaction</h3>
                <input type="hidden" id="transactionMemberId">
                <input type="hidden" id="transactionId">
                <input type="hidden" id="transactionExpectedReferenceCode">

                <div>
                    <label for="transactionAmount" class="block text-sm font-bold mb-2">Amount:</label>
                    <input type="number" id="transactionAmount" step="0.01" min="0" class="shadow-sm" required>
                </div>
                <div>
                    <label for="transactionReferenceCode" class="block text-sm font-bold mb-2">Confirm Reference Code:</label>
                    <input type="text" id="transactionReferenceCode" class="shadow-sm" placeholder="Enter member's reference code to confirm" required>
                </div>
                 <div>
                    <label for="transactionType" class="block text-sm font-bold mb-2">Transaction Type:</label>
                    <select id="transactionType" class="shadow-sm" required>
                        <option value="Payment">Payment</option>
                        <option value="Refund">Refund</option>
                        <option value="Adjustment">Adjustment</option>
                    </select>
                </div>
                <div>
                    <label for="transactionNotes" class="block text-sm font-bold mb-2">Notes (Optional):</label>
                    <textarea id="transactionNotes" rows="3" class="shadow-sm"></textarea>
                </div>
                <div class="flex justify-end pt-4">
                    <button type="submit" class="btn btn-primary">Record Transaction</button>
                </div>
            </form>

            <h3 class="text-xl font-semibold mb-4 text-primary-dark">Transaction History</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="py-3 px-4">Date</th>
                            <th class="py-3 px-4">Type</th>
                            <th class="py-3 px-4 text-right">Amount</th>
                            <th class="py-3 px-4">Notes</th>
                            <th class="py-3 px-4 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history-body">
                        </tbody>
                </table>
                <p id="loading-transactions" class="text-center py-4 hidden">Loading transactions...</p>
                <p id="error-transactions" class="text-center py-4 hidden"></p>
            </div>
            <div class="flex justify-end mt-6">
                <button type="button" onclick="closeModal('transactionModal')" class="btn btn-neutral">Close</button>
            </div>
        </div>
    </div>

    <div id="logout-modal" class="modal">
        <div class="logout-modal-content">
            <button class="modal-close-button" onclick="closeModal('logout-modal')"><i class="fas fa-times"></i></button>
            <h2>Session About to Expire!</h2>
            <p>You will be logged out in <span class="countdown" id="countdown"></span> seconds due to inactivity.</p>
            <p>Click "Stay Logged In" to continue your session.</p>
            <button id="stayLoggedInBtn">Stay Logged In</button>
        </div>
    </div>

<script src="prevent.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Initialize Supabase Client
        // IMPORTANT: Replace with your Supabase URL and Public Key.
        // It's generally safer to use environment variables for these in production.
        const supabaseUrl = 'https://sacjuubsiixwnazxjtpp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhY2p1dWJzaWl4d25henhqdHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MjQ2MDEsImV4cCI6MjA2ODIwMDYwMX0.U9TJeh25-3eEwr2y5rSmj4Kh37HXJZdWgXeqEqPTzmo';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- Supabase Authentication Check ---
        // This is crucial for verifying if the user is logged in when the page loads.
        async function checkUserSession() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error("Error getting session:", error.message);
                // Optionally redirect to login on error
                window.location.href = '/login.html'; // Assuming a login page
                return false;
            }
            if (!session) {
                console.log("No active session found. Redirecting to login.");
                window.location.href = '/login.html'; // Redirect to your login page
                return false;
            }
            console.log("User is logged in:", session.user.email);
            return true;
        }

        // --- DOM Elements ---
        const groupsTableBody = document.getElementById('groups-table-body');
        const loadingGroups = document.getElementById('loading-groups');
        const errorGroups = document.getElementById('error-groups');
        const addGroupButton = document.getElementById('addGroupButton');
        const logoutButton = document.getElementById('logoutButton'); // Added logout button
        const logoutButtonNav = document.getElementById('logout-button-nav'); // Nav logout button

        const groupMembersModal = document.getElementById('groupMembersModal');
        const modalTitle = document.getElementById('modalTitle');
        const groupMembersModalBody = document.getElementById('group-members-modal-body');
        const loadingGroupMembers = document.getElementById('loading-group-members');
        const errorGroupMembers = document.getElementById('error-group-members');
        const addMemberButton = document.getElementById('addMemberButton');

        let currentGroupId = null;
        let currentMemberId = null;

        const groupFormModal = document.getElementById('groupFormModal');
        const groupFormModalTitle = document.getElementById('groupFormModalTitle');
        const groupForm = document.getElementById('groupForm');
        const groupIdInput = document.getElementById('groupId');
        const groupNameInput = document.getElementById('groupName');
        const groupReferenceCodeInput = document.getElementById('groupReferenceCode');

        const memberFormModal = document.getElementById('memberFormModal');
        const memberFormModalTitle = document.getElementById('memberFormModalTitle');
        const memberForm = document.getElementById('memberForm');
        const memberIdInput = document.getElementById('memberId');
        const memberGroupIdInput = document.getElementById('memberGroupId');
        const memberNameInput = document.getElementById('memberName');
        const memberTicketTypeInput = document.getElementById('memberTicketType');
        const memberTicketPriceInput = document.getElementById('memberTicketPrice');
        const memberQuantityInput = document.getElementById('memberQuantity');
        const memberReferenceCodeInput = document.getElementById('memberReferenceCode');

        const addTicketModal = document.getElementById('addTicketModal');
        const addTicketModalTitle = document.getElementById('addTicketModalTitle');
        const addTicketMemberNameSpan = document.getElementById('addTicketMemberName');
        const addTicketForm = document.getElementById('addTicketForm');
        const addTicketMemberIdInput = document.getElementById('addTicketMemberId');
        const addTicketCurrentQuantityInput = document.getElementById('addTicketCurrentQuantity');
        const addTicketCurrentTicketTypeInput = document.getElementById('addTicketCurrentTicketType');
        const addTicketCurrentTicketPriceInput = document.getElementById('addTicketCurrentTicketPrice');
        const addTicketExpectedReferenceCodeInput = document.getElementById('addTicketExpectedReferenceCode');
        const addTicketQuantityInput = document.getElementById('addTicketQuantity');
        const addTicketTypeInput = document.getElementById('addTicketType');
        const addTicketPriceInput = document.getElementById('addTicketPrice');
        const addTicketReferenceCodeInput = document.getElementById('addTicketReferenceCode');
        const currentTicketTypeDisplay = document.getElementById('currentTicketTypeDisplay');
        const currentTicketPriceDisplay = document.getElementById('currentTicketPriceDisplay');

        const transactionModal = document.getElementById('transactionModal');
        const transactionModalTitle = document.getElementById('transactionModalTitle');
        const currentMemberNameSpan = document.getElementById('currentMemberName');
        const transactionForm = document.getElementById('transactionForm');
        const transactionMemberIdInput = document.getElementById('transactionMemberId');
        const transactionIdInput = document.getElementById('transactionId');
        const transactionAmountInput = document.getElementById('transactionAmount');
        const transactionReferenceCodeInput = document.getElementById('transactionReferenceCode');
        const transactionExpectedReferenceCodeInput = document.getElementById('transactionExpectedReferenceCode');
        const transactionNotesInput = document.getElementById('transactionNotes');
        const transactionHistoryBody = document.getElementById('transaction-history-body');
        const loadingTransactions = document.getElementById('loading-transactions');
        const errorTransactions = document.getElementById('error-transactions');
        const transactionTypeInput = document.getElementById('transactionType'); // New: for transaction type dropdown
        // Removed currency and status inputs
        // const transactionCurrencyInput = document.getElementById('transactionCurrency');
        // const transactionStatusInput = document.getElementById('transactionStatus');

        const memberSearchInput = document.getElementById('memberSearchInput');
        const searchResultsDiv = document.getElementById('searchResults');

        let currentOpenDropdown = null;

        // --- Utility Functions ---

        function showLoading(element) {
            element.classList.remove('hidden');
        }

        function hideLoading(element) {
            element.classList.add('hidden');
        }

        function showError(element, message) {
            element.textContent = message;
            element.classList.remove('hidden');
        }

        function hideError(element) {
            element.classList.add('hidden');
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.style.display = 'flex'; // Set display to flex immediately
            setTimeout(() => modal.classList.add('show'), 10); // Add 'show' class after a tiny delay for transition
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('show');
            modal.addEventListener('transitionend', function handler() {
                modal.style.display = 'none'; // Hide after transition
                modal.removeEventListener('transitionend', handler);
            });
        }

        // --- Auto-Logout Implementation ---
        const INACTIVITY_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes of inactivity
        const WARNING_TIME_MS = 30 * 1000;          // Show warning 30 seconds before logout
        const LOGOUT_REDIRECT_URL = 'login.html';  // Where to redirect after logout

        let inactivityTimeoutId;            // Main timer for inactivity detection
        let warningTimeoutId;               // Timer for the warning countdown
        let countdownIntervalId;            // Interval for updating the countdown display
        let countdownSeconds = WARNING_TIME_MS / 1000; // Initial countdown value

        const logoutModal = document.getElementById('logout-modal');
        const stayLoggedInButton = document.getElementById('stayLoggedInBtn');
        const countdownDisplay = document.getElementById('countdown');

        /**
         * Logs out the user via Supabase and redirects.
         */
        async function performLogout() {
            clearAllLogoutTimers();
            console.log("Logging out due to inactivity...");
            alert("You have been logged out due to inactivity.");

            // Supabase signOut
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Supabase logout error:', error.message);
            }
            window.location.href = LOGOUT_REDIRECT_URL;
        }

        /**
         * Resets the inactivity timer. Called on user activity.
         */
        function resetInactivityTimer() {
            clearTimeout(inactivityTimeoutId);
            closeModal('logout-modal'); // Use the new closeModal function
            startInactivityTimer(); // Restart the timer
        }

        /**
         * Starts the main inactivity timer.
         */
        function startInactivityTimer() {
            inactivityTimeoutId = setTimeout(() => {
                openModal('logout-modal'); // Use the new openModal function
                countdownSeconds = WARNING_TIME_MS / 1000; // Reset countdown
                updateCountdownDisplay(); // Initial display
                warningTimeoutId = setTimeout(performLogout, WARNING_TIME_MS);
                countdownIntervalId = setInterval(updateCountdownDisplay, 1000);
            }, INACTIVITY_TIMEOUT_MS - WARNING_TIME_MS);
        }

        /**
         * Updates the countdown display in the modal.
         */
        function updateCountdownDisplay() {
            countdownDisplay.textContent = countdownSeconds;
            if (countdownSeconds <= 0) {
                clearInterval(countdownIntervalId);
            }
            countdownSeconds--;
        }

        /**
         * Clears all timers related to inactivity and warning.
         */
        function clearAllLogoutTimers() {
            clearTimeout(inactivityTimeoutId);
            clearTimeout(warningTimeoutId);
            clearInterval(countdownIntervalId);
        }

        // --- Global Activity Listeners for Logout Timer ---
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        document.addEventListener('click', resetInactivityTimer);
        document.addEventListener('scroll', resetInactivityTimer);

        // --- Event Listener for "Stay Logged In" button ---
        stayLoggedInButton.addEventListener('click', () => {
            resetInactivityTimer(); // Reset all timers and hide modal
        });

        // Event listener for the manual Logout button
        logoutButton.addEventListener('click', async () => {
            if (confirm("Are you sure you want to log out?")) {
                await performLogout();
            }
        });

        logoutButtonNav.addEventListener('click', async () => {
            if (confirm("Are you sure you want to log out?")) {
                await performLogout();
            }
        });

        // --- Group Management Functions ---

        async function fetchGroups() {
            showLoading(loadingGroups);
            hideError(errorGroups);
            groupsTableBody.innerHTML = ''; // Clear existing data

            try {
                const { data, error } = await supabase
                    .from('groups')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                if (data.length === 0) {
                    groupsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-text-light">No groups found. Click "Add New Group" to create one.</td></tr>`;
                } else {
                    data.forEach(group => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="uuid-cell">${group.id}</td>
                            <td>${group.name}</td>
                            <td class="code-cell">${group.reference_code || 'N/A'}</td>
                            <td class="timestamp-cell">${new Date(group.created_at).toLocaleString()}</td>
                            <td class="action-buttons">
                                <button class="edit-button" data-id="${group.id}" title="Edit Group">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="delete-button ml-1" data-id="${group.id}" data-name="${group.name}" title="Delete Group">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        // Add click event listeners to non-action cells to view members
                        row.querySelectorAll('td:not(.action-buttons)').forEach(cell => {
                            cell.addEventListener('click', () => showGroupMembersInGroup(group.id, group.name));
                            cell.classList.add('cursor-pointer'); // Hover effect handled by CSS
                        });

                        row.querySelector('.edit-button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            openGroupFormModalForEdit(group);
                        });
                        row.querySelector('.delete-button').addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteGroup(group.id, group.name);
                        });

                        groupsTableBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching groups:', error.message);
                showError(errorGroups, `Failed to load groups: ${error.message}. Please check your Supabase configuration and RLS policies.`);
                groupsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger-color">Error loading groups.</td></tr>`;
            } finally {
                hideLoading(loadingGroups);
            }
        }

        // Event listener for opening the Add Group modal
        addGroupButton.addEventListener('click', () => {
            groupFormModalTitle.textContent = 'Add New Group';
            groupForm.reset();
            groupIdInput.value = '';
            openModal('groupFormModal');
        });

        function openGroupFormModalForEdit(group) {
            groupFormModalTitle.textContent = 'Edit Group';
            groupIdInput.value = group.id;
            groupNameInput.value = group.name;
            groupReferenceCodeInput.value = group.reference_code || '';
            openModal('groupFormModal');
        }

        groupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = groupIdInput.value;
            const name = groupNameInput.value;
            const reference_code = groupReferenceCodeInput.value || null;

            if (!name.trim()) {
                alert('Please enter a group name.');
                return;
            }

            try {
                if (id) {
                    const { error } = await supabase
                        .from('groups')
                        .update({ name, reference_code })
                        .eq('id', id);
                    if (error) throw error;
                    alert('Group updated successfully!');
                } else {
                    const { error } = await supabase
                        .from('groups')
                        .insert({ name, reference_code });
                    if (error) throw error;
                    alert('Group added successfully!');
                }
                closeModal('groupFormModal');
                fetchGroups();
            } catch (error) {
                console.error('Error saving group:', error.message);
                alert(`Error saving group: ${error.message}`);
            }
        });

        async function deleteGroup(id, name) {
            if (!confirm(`Are you sure you want to delete the group "${name}"? This will also delete all associated members and their transactions.`)) {
                return;
            }

            try {
                const { error: groupError } = await supabase
                    .from('groups')
                    .delete()
                    .eq('id', id);

                if (groupError) throw groupError;

                alert('Group and its associated data deleted successfully!');
                fetchGroups();
            } catch (error) {
                console.error('Error deleting group:', error.message);
                alert(`Error deleting group: ${error.message}`);
            }
        }

        // --- Group Member Management Functions ---

        addMemberButton.addEventListener('click', () => {
            if (!currentGroupId) {
                alert('Error: No group selected to add a member to.');
                return;
            }
            memberFormModalTitle.textContent = 'Add New Member';
            memberForm.reset();
            memberIdInput.value = '';
            memberGroupIdInput.value = currentGroupId;
            memberNameInput.focus(); // Focus on the first input
            openModal('memberFormModal');
        });

        async function showGroupMembersInGroup(groupId, groupName, memberIdToHighlight = null) {
            currentGroupId = groupId;
            openModal('groupMembersModal');
            modalTitle.textContent = `Group Members in Group: ${groupName}`;
            showLoading(loadingGroupMembers);
            hideError(errorGroupMembers);
            groupMembersModalBody.innerHTML = '';

            try {
                const { data: members, error: membersError } = await supabase
                    .from('group_members')
                    .select(`
                        id,
                        name,
                        ticket_type,
                        ticket_price,
                        quantity,
                        reference_code,
                        group_id
                    `)
                    .eq('group_id', groupId)
                    .order('name', { ascending: true });

                if (membersError) throw membersError;

                const memberIds = members.map(m => m.id);

                let transactionsData = [];
                if (memberIds.length > 0) {
                    // Fetch all relevant transactions in one go
                    const { data: transactions, error: transactionsError } = await supabase
                        .from('transactions') // Corrected table name
                        .select('member_id, amount, transaction_type')
                        .in('member_id', memberIds);

                    if (transactionsError) {
                        console.warn('Warning fetching transactions for members:', transactionsError.message);
                    } else {
                        transactionsData = transactions;
                    }
                }

                const COLSPAN_COUNT = 9; // Changed from 10 to 9 as ID column is removed

                if (members.length === 0) {
                    groupMembersModalBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-text-light">No members found in this group. Click "Add New Member" to add one.</td></tr>`;
                } else {
                    members.forEach(member => {
                        const memberTransactions = transactionsData.filter(t => t.member_id === member.id);
                        const totalDue = (parseFloat(member.ticket_price) * parseInt(member.quantity));
                        const totalPaid = memberTransactions.reduce((sum, transaction) => {
                            // Only sum 'Payment' type transactions for 'Amount Paid'
                            return sum + (transaction.transaction_type === 'Payment' ? parseFloat(transaction.amount) : 0);
                        }, 0);
                        const balanceDue = totalDue - totalPaid;

                        const row = document.createElement('tr');
                        if (memberIdToHighlight && member.id === memberIdToHighlight) {
                            row.classList.add('bg-blue-100', 'border-blue-500', 'border-l-4'); // Highlight row
                            setTimeout(() => row.scrollIntoView({ behavior: 'smooth', block: 'center' }), 300); // Scroll to it
                        }

                        row.innerHTML = `
                            <!-- Removed ID cell -->
                            <td>${member.name}</td>
                            <td>${member.ticket_type || 'N/A'}</td>
                            <td class="numeric-cell">₱${parseFloat(member.ticket_price).toFixed(2)}</td>
                            <td class="numeric-cell">${member.quantity}</td>
                            <td class="numeric-cell font-bold text-primary-dark">₱${totalDue.toFixed(2)}</td>
                            <td class="numeric-cell font-bold text-accent-color">₱${totalPaid.toFixed(2)}</td>
                            <td class="numeric-cell font-bold ${balanceDue > 0 ? 'text-danger-color' : 'text-text-color'}">₱${balanceDue.toFixed(2)}</td>
                            <td class="code-cell">${member.reference_code || 'N/A'}</td>
                            <td class="action-buttons">
                                <div class="dropdown-container">
                                    <button class="kebab-button" data-member-id="${member.id}" title="More Actions">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div class="dropdown-menu" id="dropdown-${member.id}">
                                        <button class="edit-action" data-action="edit">
                                            <i class="fas fa-edit"></i> Edit Member
                                        </button>
                                        <button class="payment-action" data-action="payment">
                                            <i class="fas fa-money-bill-wave"></i> Add Payment / View Transactions
                                        </button>
                                        <button class="ticket-action" data-action="add-ticket">
                                            <i class="fas fa-ticket-alt"></i> Add More Tickets
                                        </button>
                                        <button class="delete-action" data-action="delete">
                                            <i class="fas fa-trash-alt"></i> Delete Member
                                        </button>
                                    </div>
                                </div>
                            </td>
                        `;

                        const kebabButton = row.querySelector('.kebab-button');
                        kebabButton.memberData = member; // Attach the full member object

                        kebabButton.addEventListener('click', (e) => {
                            e.stopPropagation();
                            toggleMemberActionsDropdown(e.currentTarget);
                        });

                        const dropdownMenu = row.querySelector('.dropdown-menu');
                        dropdownMenu.addEventListener('click', (e) => {
                            e.stopPropagation();
                            const actionButton = e.target.closest('button');
                            if (actionButton) {
                                const action = actionButton.dataset.action;
                                const memberToActOn = kebabButton.memberData;

                                closeAllDropdowns();

                                if (!memberToActOn) {
                                    alert('Error: Member data not found for action. Please try again.');
                                    return;
                                }

                                switch (action) {
                                    case 'edit':
                                        openMemberFormModalForEdit(memberToActOn);
                                        break;
                                    case 'payment':
                                        showTransactionsForMember(memberToActOn.id, memberToActOn.name, memberToActOn.reference_code);
                                        break;
                                    case 'add-ticket':
                                        openAddTicketModal(memberToActOn);
                                        break;
                                    case 'delete':
                                        deleteMember(memberToActOn.id, memberToActOn.name);
                                        break;
                                    default:
                                        console.warn('Unknown action:', action);
                                }
                            }
                        });
                        groupMembersModalBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching group members:', error.message);
                showError(errorGroupMembers, `Failed to load group members: ${error.message}.`);
                groupMembersModalBody.innerHTML = `<tr><td colspan="${COLSPAN_COUNT}" class="text-center py-4 text-danger-color">Error loading group members.</td></tr>`;
            } finally {
                hideLoading(loadingGroupMembers);
            }
        }

        function closeGroupMembersModal() {
            closeModal('groupMembersModal');
            currentGroupId = null;
            closeAllDropdowns();
        }

        function openMemberFormModalForEdit(member) {
            memberFormModalTitle.textContent = 'Edit Member';
            memberIdInput.value = member.id;
            memberGroupIdInput.value = member.group_id;
            memberNameInput.value = member.name;
            memberTicketTypeInput.value = member.ticket_type || '';
            memberTicketPriceInput.value = member.ticket_price;
            memberQuantityInput.value = member.quantity;
            memberReferenceCodeInput.value = member.reference_code || '';
            openModal('memberFormModal');
        }

        memberForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = memberIdInput.value;
            const group_id = memberGroupIdInput.value;
            const name = memberNameInput.value;
            const ticket_type = memberTicketTypeInput.value;
            const ticket_price = parseFloat(memberTicketPriceInput.value);
            const quantity = parseInt(memberQuantityInput.value);
            const reference_code = memberReferenceCodeInput.value || null;

            if (isNaN(ticket_price) || ticket_price < 0) {
                alert('Please enter a valid ticket price (a non-negative number).');
                return;
            }
            if (isNaN(quantity) || quantity < 1) {
                alert('Please enter a valid quantity (minimum 1).');
                return;
            }
            if (!ticket_type) {
                alert('Please select a ticket type.');
                return;
            }
            if (!name.trim()) {
                alert('Please enter a member name.');
                return;
            }
            try {
                if (id) {
                    const { error } = await supabase
                        .from('group_members')
                        .update({ name, ticket_type, ticket_price, quantity, reference_code })
                        .eq('id', id);
                    if (error) throw error;
                    alert('Member updated successfully!');
                } else {
                    const { error } = await supabase
                        .from('group_members')
                        .insert({ group_id, name, ticket_type, ticket_price, quantity, reference_code });
                    if (error) throw error;
                    alert('Member added successfully!');
                }
                closeModal('memberFormModal');

                if (group_id && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(group_id, groupNameMatch[1]);
                    } else {
                        console.warn('Could not extract group name from modal title. Refreshing all groups.');
                        fetchGroups();
                    }
                } else {
                    fetchGroups();
                }

            } catch (error) {
                console.error('Error saving member:', error.message);
                alert(`Error saving member: ${error.message}`);
            }
        });

        async function deleteMember(id, name) {
            if (!confirm(`Are you sure you want to delete the member "${name}"? This will also delete all associated transactions.`)) {
                return;
            }

            try {
                // Assuming ON DELETE CASCADE is set up on the 'transactions' table to delete related transactions.
                const { error } = await supabase
                    .from('group_members')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                alert('Member and its transactions deleted successfully!');
                if (currentGroupId && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(currentGroupId, groupNameMatch[1]);
                    } else {
                        fetchGroups();
                    }
                } else {
                    fetchGroups();
                }

            } catch (error) {
                console.error('Error deleting member:', error.message);
                alert(`Error deleting member: ${error.message}`);
            }
        }

        // --- Add Ticket Functions ---
        function openAddTicketModal(member) {
            addTicketModalTitle.textContent = `Add Tickets for: ${member.name}`;
            addTicketMemberNameSpan.textContent = member.name;
            addTicketMemberIdInput.value = member.id;
            addTicketCurrentQuantityInput.value = member.quantity;
            addTicketCurrentTicketTypeInput.value = member.ticket_type;
            addTicketCurrentTicketPriceInput.value = member.ticket_price;
            addTicketExpectedReferenceCodeInput.value = member.reference_code || '';
            currentTicketTypeDisplay.textContent = member.ticket_type || 'N/A';
            currentTicketPriceDisplay.textContent = parseFloat(member.ticket_price).toFixed(2);
            addTicketForm.reset();
            addTicketQuantityInput.value = '1';
            addTicketTypeInput.value = '';
            addTicketPriceInput.value = ''; // Clear new ticket price input
            addTicketReferenceCodeInput.value = ''; // Clear confirmation ref code
            openModal('addTicketModal');
        }

        addTicketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = addTicketMemberIdInput.value;
            const currentQuantity = parseInt(addTicketCurrentQuantityInput.value);
            const currentTicketType = addTicketCurrentTicketTypeInput.value;
            const currentTicketPrice = parseFloat(addTicketCurrentTicketPriceInput.value);
            const expectedRefCode = addTicketExpectedReferenceCodeInput.value;
            const userRefCode = addTicketReferenceCodeInput.value.trim();

            if (expectedRefCode === null || expectedRefCode === "") {
                alert('Error: This member does not have a reference code. Cannot proceed with this action. Please edit the member and add a reference code first.');
                return;
            }
            if (userRefCode !== expectedRefCode) {
                alert('Error: The provided reference code does not match the member\'s reference code. Please try again.');
                return;
            }

            const quantityToAdd = parseInt(addTicketQuantityInput.value);
            const newTicketType = addTicketTypeInput.value.trim();
            const newTicketPriceInputVal = addTicketPriceInput.value.trim();
            const newTicketPrice = newTicketPriceInputVal === '' ? currentTicketPrice : parseFloat(newTicketPriceInputVal); // Default to current price if empty

            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                alert('Please enter a valid number of tickets to add (minimum 1).');
                return;
            }
            if (newTicketType && (isNaN(newTicketPrice) || newTicketPrice < 0)) {
                alert('Please enter a valid price for the new ticket type.');
                return;
            }
            if (!newTicketType && newTicketPriceInputVal !== '' && (isNaN(newTicketPrice) || newTicketPrice < 0)) {
                 alert('Please enter a valid price for the ticket price update.');
                 return;
            }


            let updatedQuantity;
            let finalTicketType;
            let finalTicketPrice;
            let transactionAmount = 0;
            let transactionNotes = '';
            let transactionType = 'Adjustment'; // Default transaction type for ticket changes

            if (newTicketType) {
                // If a new ticket type is specified, it becomes the primary, and quantityToAdd is the new total quantity.
                finalTicketType = newTicketType;
                finalTicketPrice = newTicketPrice;
                updatedQuantity = quantityToAdd; // This is now the *new total quantity* for the new type
                transactionAmount = quantityToAdd * finalTicketPrice; // Amount based on the new tickets
                transactionNotes = `Changed primary ticket type to ${finalTicketType} and added ${quantityToAdd} tickets @ ₱${finalTicketPrice.toFixed(2)} each.`;
            } else {
                // Just adding more of the existing ticket type
                finalTicketType = currentTicketType;
                finalTicketPrice = currentTicketPrice; // Keep existing price
                updatedQuantity = currentQuantity + quantityToAdd;
                transactionAmount = quantityToAdd * currentTicketPrice; // Amount based on adding more existing tickets
                transactionNotes = `Added ${quantityToAdd} more ${currentTicketType} tickets @ ₱${currentTicketPrice.toFixed(2)} each.`;
            }

            // Handle potential price-only update (without changing type or adding quantity in the primary sense)
            if (!newTicketType && newTicketPriceInputVal !== '' && newTicketPrice !== currentTicketPrice) {
                finalTicketPrice = newTicketPrice;
                // If only price changed, but no new quantity added, transaction amount is 0, notes reflect price update
                if (quantityToAdd === 0 || isNaN(quantityToAdd)) { // If quantity was not explicitly increased
                    transactionAmount = 0;
                    transactionNotes = `Updated price for ${finalTicketType} tickets to ₱${finalTicketPrice.toFixed(2)}. Quantity remains ${updatedQuantity || currentQuantity}.`;
                } else { // If price changed AND quantity added
                     transactionNotes = `Added ${quantityToAdd} ${finalTicketType} tickets at new price ₱${finalTicketPrice.toFixed(2)}. Total tickets: ${updatedQuantity}.`;
                }
            }


            try {
                // Update member's ticket details
                const { error: memberUpdateError } = await supabase
                    .from('group_members')
                    .update({
                        quantity: updatedQuantity,
                        ticket_type: finalTicketType,
                        ticket_price: finalTicketPrice
                    })
                    .eq('id', memberId);

                if (memberUpdateError) throw memberUpdateError;

                // Record the transaction for the ticket change
                if (transactionAmount > 0 || transactionNotes) { // Only add transaction if there's an amount or specific notes
                    const { error: transactionError } = await supabase
                        .from('transactions') // Corrected table name
                        .insert({
                            member_id: memberId,
                            amount: transactionAmount,
                            transaction_type: transactionType,
                            reference_code: userRefCode, // Store the confirmed reference code
                            notes: transactionNotes,
                            transaction_date: new Date().toISOString() // Use current date for transaction_date
                        });

                    if (transactionError) {
                        console.warn('Warning: Failed to record transaction for ticket update:', transactionError.message);
                    }
                }

                alert('Tickets updated successfully!');
                closeModal('addTicketModal');
                // Refresh the group members modal to show updated values
                if (currentGroupId && modalTitle.textContent) {
                    const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                    if (groupNameMatch && groupNameMatch[1]) {
                        showGroupMembersInGroup(currentGroupId, groupNameMatch[1]);
                    }
                } else {
                    fetchGroups(); // Fallback to refreshing all groups
                }

            } catch (error) {
                console.error('Error updating tickets or member:', error.message);
                alert(`Error updating tickets or member: ${error.message}`);
            }
        });


        // --- Transaction Functions ---

        async function showTransactionsForMember(memberId, memberName, memberRefCode) {
            currentMemberId = memberId;
            openModal('transactionModal');
            transactionModalTitle.textContent = `Transactions for: ${memberName}`;
            currentMemberNameSpan.textContent = memberName;
            transactionMemberIdInput.value = memberId;
            transactionExpectedReferenceCodeInput.value = memberRefCode || ''; // Store member's ref code
            transactionForm.reset();
            transactionReferenceCodeInput.value = ''; // Clear user input field

            showLoading(loadingTransactions);
            hideError(errorTransactions);
            transactionHistoryBody.innerHTML = '';

            try {
               const { data, error } = await supabase
                .from('transactions') // Corrected table name
                .select('*')
                .eq('member_id', memberId)
                .order('transaction_date', { ascending: false }); // Order by transaction_date

                if (error) throw error;

                if (data.length === 0) {
                    transactionHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-text-light">No transactions for this member.</td></tr>`;
                } else {
                    data.forEach(transaction => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="timestamp-cell">${new Date(transaction.transaction_date).toLocaleString()}</td>
                            <td>${transaction.transaction_type}</td>
                            <td class="numeric-cell">₱${parseFloat(transaction.amount).toFixed(2)}</td>
                            <td>${transaction.notes || 'N/A'}</td>
                            <td class="action-buttons">
                                <button class="delete-transaction-button" data-id="${transaction.transaction_id}" title="Delete Transaction">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        `;
                        row.querySelector('.delete-transaction-button').addEventListener('click', (e) => {
                            deleteTransaction(transaction.transaction_id, memberId, memberName, memberRefCode);
                        });
                        transactionHistoryBody.appendChild(row);
                    });
                }
            } catch (error) {
                console.error('Error fetching transactions:', error.message);
                showError(errorTransactions, `Failed to load transactions: ${error.message}.`);
                transactionHistoryBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-danger-color">Error loading transactions.</td></tr>`;
            } finally {
                hideLoading(loadingTransactions);
            }
        }

        function closeTransactionModal() {
            closeModal('transactionModal');
            currentMemberId = null;
        }

        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const memberId = transactionMemberIdInput.value;
            const amount = parseFloat(transactionAmountInput.value);
            const userRefCode = transactionReferenceCodeInput.value.trim();
            const expectedRefCode = transactionExpectedReferenceCodeInput.value;
            const notes = transactionNotesInput.value || null;
            const transactionType = transactionTypeInput.value; // Get selected transaction type
            // Removed currency and status
            // const currency = transactionCurrencyInput.value;
            // const status = transactionStatusInput.value;

            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid amount for the transaction.');
                return;
            }
            if (expectedRefCode === null || expectedRefCode === "") {
                alert('Error: This member does not have a reference code. Cannot record transaction. Please edit the member and add a reference code first.');
                return;
            }
            if (userRefCode !== expectedRefCode) {
                alert('Error: The provided reference code does not match the member\'s reference code. Please try again.');
                return;
            }

            try {
                const { error } = await supabase
                    .from('transactions') // Corrected table name
                    .insert({
                        member_id: memberId,
                        amount: amount,
                        transaction_type: transactionType,
                        reference_code: userRefCode, // Store the confirmed reference code
                        notes: notes,
                        // Removed currency and status
                        // currency: currency,
                        // status: status,
                        transaction_date: new Date().toISOString() // Set transaction_date
                    });

                if (error) throw error;

                alert('Transaction recorded successfully!');
                transactionForm.reset();
                transactionReferenceCodeInput.value = ''; // Clear user input field
                // Removed currency and status reset
                // transactionCurrencyInput.value = 'PHP';
                // transactionStatusInput.value = 'Completed';

                // Re-fetch transactions and also refresh member list to update balance
                const memberName = currentMemberNameSpan.textContent;
                const memberRefCode = transactionExpectedReferenceCodeInput.value;
                showTransactionsForMember(memberId, memberName, memberRefCode); // Refresh transaction history
                if (currentGroupId && modalTitle.textContent) {
                     const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                     if (groupNameMatch && groupNameMatch[1]) {
                         showGroupMembersInGroup(currentGroupId, groupNameMatch[1]); // Refresh member list
                     }
                }
            } catch (error) {
                console.error('Error recording transaction:', error.message);
                alert(`Error recording transaction: ${error.message}`);
            }
        });

        async function deleteTransaction(transactionId, memberId, memberName, memberRefCode) {
            if (!confirm('Are you sure you want to delete this transaction? This action cannot be undone.')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('transactions') // Corrected table name
                    .delete()
                    .eq('transaction_id', transactionId); // Use transaction_id as primary key

                if (error) throw error;

                alert('Transaction deleted successfully!');
                showTransactionsForMember(memberId, memberName, memberRefCode); // Refresh transaction history
                if (currentGroupId && modalTitle.textContent) {
                     const groupNameMatch = modalTitle.textContent.match(/Group Members in Group: (.+)/);
                     if (groupNameMatch && groupNameMatch[1]) {
                         showGroupMembersInGroup(currentGroupId, groupNameMatch[1]); // Refresh member list
                     }
                }
            } catch (error) {
                console.error('Error deleting transaction:', error.message);
                alert(`Error deleting transaction: ${error.message}`);
            }
        }


        // --- Dropdown Management ---

        function toggleMemberActionsDropdown(button) {
            const dropdownMenu = button.nextElementSibling; // The dropdown is the next sibling
            if (currentOpenDropdown && currentOpenDropdown !== dropdownMenu) {
                currentOpenDropdown.classList.remove('show'); // Close other open dropdown
            }
            dropdownMenu.classList.toggle('show');
            currentOpenDropdown = dropdownMenu.classList.contains('show') ? dropdownMenu : null;
        }

        // Close dropdown if clicked outside
        document.addEventListener('click', (e) => {
            if (currentOpenDropdown && !e.target.closest('.dropdown-container')) {
                closeAllDropdowns();
            }
        });

        function closeAllDropdowns() {
            if (currentOpenDropdown) {
                currentOpenDropdown.classList.remove('show');
                currentOpenDropdown = null;
            }
        }

        // --- Search Functionality ---
        let allMembers = []; // Cache all members for search

        async function fetchAllMembersForSearch() {
            const { data, error } = await supabase
                .from('group_members')
                .select('id, name, reference_code, group_id, groups(name)'); // Also fetch group name

            if (error) {
                console.error('Error fetching all members for search:', error.message);
                return [];
            }
            allMembers = data;
            return data;
        }

        memberSearchInput.addEventListener('input', debounce(handleMemberSearch, 300));
        memberSearchInput.addEventListener('focus', () => {
            if (memberSearchInput.value.length > 0 && searchResultsDiv.children.length > 0) {
                searchResultsDiv.classList.remove('hidden');
            }
        });
        memberSearchInput.addEventListener('blur', (e) => {
            // Delay hiding to allow click on results
            setTimeout(() => {
                if (!searchResultsDiv.contains(e.relatedTarget)) { // Check if focus moved outside search results
                    searchResultsDiv.classList.add('hidden');
                }
            }, 100);
        });


        async function handleMemberSearch(event) {
            const query = event.target.value.toLowerCase();
            searchResultsDiv.innerHTML = '';

            if (query.length < 2) { // Require at least 2 characters for search
                searchResultsDiv.classList.add('hidden');
                return;
            }

            if (allMembers.length === 0) {
                await fetchAllMembersForSearch(); // Fetch if not already cached
            }

            const filteredMembers = allMembers.filter(member =>
                member.name.toLowerCase().includes(query) ||
                (member.reference_code && member.reference_code.toLowerCase().includes(query))
            );

            if (filteredMembers.length > 0) {
                filteredMembers.forEach(member => {
                    const item = document.createElement('div');
                    item.classList.add('search-results-item');
                    item.innerHTML = `
                        <strong>${member.name}</strong>
                        <span>(Group: ${member.groups.name || 'N/A'}, Ref: ${member.reference_code || 'N/A'})</span>
                    `;
                    item.addEventListener('click', () => selectSearchResult(member));
                    searchResultsDiv.appendChild(item);
                });
                searchResultsDiv.classList.remove('hidden');
            } else {
                searchResultsDiv.classList.add('hidden');
            }
        }

        function selectSearchResult(member) {
            memberSearchInput.value = `${member.name} (${member.reference_code || 'N/A'})`;
            searchResultsDiv.classList.add('hidden');
            // Now, open the group members modal and highlight the member
            showGroupMembersInGroup(member.group_id, member.groups.name, member.id);
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            // First, check if the user is authenticated.
            const isAuthenticated = await checkUserSession();
            if (isAuthenticated) {
                // Only fetch data and start timers if the user is logged in.
                fetchGroups();
                fetchAllMembersForSearch(); // Pre-fetch members for search
                startInactivityTimer();
                console.log("Automatic logout timer started.");
            }

            // Attach click outside listener to all modals
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    // If the click target is the modal itself (the backdrop), close it
                    if (e.target === modal) {
                        closeModal(modal.id);
                    }
                });
            });

            // Initially hide all modals that don't have 'display: none' in CSS
            // This ensures they are hidden on page load before any JS runs
            document.querySelectorAll('.modal').forEach(modal => {
                if (!modal.classList.contains('show')) { // Only hide if not explicitly shown by some other initial logic
                    modal.style.display = 'none';
                }
            });
        });

    </script>
</body>
</html>
