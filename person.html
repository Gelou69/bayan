<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Members & Tickets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       :root {
            --primary-color: #4A6572; /* Dark Teal */
            --secondary-color: #87979B; /* Muted Blue-Gray */
            --accent-color: #F9AA33; /* Warm Orange */
            --light-bg: #F5F7FA; /* Off-white / Light Gray */
            --dark-text: #344955; /* Dark Slate Gray */
            --light-text: #ECEFF1; /* Light Gray for contrast */
            --border-color: #DDE1E6; /* Light border */
            --hover-light: rgba(74, 101, 114, 0.1); /* Light hover for table rows */
            --button-hover-bg: linear-gradient(135deg, #e69a2d, #f0b55c); /* Slightly darker/shifted gradient */
            --box-shadow-light: 0 4px 12px rgba(0, 0, 0, 0.08);
            --box-shadow-medium: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Open Sans', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- Header & Navigation --- */
        .header {
            background-color: var(--primary-color);
            padding: 1rem 2rem;
            box-shadow: var(--box-shadow-medium);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar {
            display: flex;
            justify-content: flex-end; /* Align items to the right */
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .navbar a,
        .navbar button {
            color: var(--light-text);
            text-decoration: none;
            padding: 0.75rem 1.25rem;
            margin-left: 1rem;
            font-weight: 600;
            font-size: 1rem;
            border-radius: 6px;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
            position: relative;
            overflow: hidden; /* For pseudo-element animation */
            background: none; /* Reset button default background */
            border: none; /* Reset button default border */
            cursor: pointer;
        }

        .navbar a:hover,
        .navbar button:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px); /* Subtle lift */
        }
        
        .navbar a::before,
        .navbar button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1); /* Subtle highlight */
            transition: left 0.3s ease;
            z-index: 0;
        }

        .navbar a:hover::before,
        .navbar button:hover::before {
            left: 0;
        }

        .navbar a span,
        .navbar button span {
            position: relative;
            z-index: 1;
        }

        #logout-button {
            background: linear-gradient(90deg, #F08080 0%, #E7625F 100%); /* Soft red for logout */
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 700;
            box-shadow: var(--box-shadow-light);
        }

        #logout-button:hover {
            background: linear-gradient(90deg, #E7625F 0%, #CF4A47 100%);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-medium);
        }

        /* --- Main Content Layout --- */
        .table-container {
            max-width: 1200px;
            margin: 2rem auto;
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            box-shadow: var(--box-shadow-light);
            transition: transform 0.5s ease-out, opacity 0.5s ease-out;
            opacity: 1;
            transform: translateY(0);
        }

        .content-hidden {
            opacity: 0;
            transform: translateY(20px);
        }

        h2 {
            font-family: 'Merriweather', serif;
            font-size: 2.2rem;
            color: var(--dark-text);
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 700;
        }

        /* --- Table Styling --- */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 1.5rem;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners on table */
        }

        th,
        td {
            padding: 1rem 1.2rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--primary-color);
            color: var(--light-text);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
        }

        tbody tr:nth-child(even) {
            background-color: #FDFEFE; /* Very light subtle stripe */
        }

        tbody tr:hover {
            background-color: var(--hover-light);
            transform: scale(1.005); /* Slight grow effect */
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05); /* Subtle shadow on hover */
        }
        
        td {
            color: var(--dark-text);
            font-size: 0.95rem;
        }

        .numeric-cell {
            text-align: right;
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
        }

        .uuid-cell, .code-cell {
            font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, Courier, monospace;
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        .timestamp-cell {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }

        /* --- Table Actions (Dropdown) --- */
        
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dots-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            transition: color 0.2s ease, background-color 0.2s ease;
        }

        .dots-button:hover {
            color: var(--primary-color);
            background-color: rgba(0, 0, 0, 0.05);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #ffffff;
            min-width: 160px;
            box-shadow: var(--box-shadow-medium);
            border-radius: 8px;
            z-index: 1;
            right: 0;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity 0.3s ease, transform 0.3s ease;
            max-height: 200px; /* Set a max height */
            overflow-y: auto; /* Enable vertical scrolling */
            border: 1px solid var(--border-color); /* Add border for better visual */
        }
   .dropdown.show .dropdown-content {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .dropdown-content button {
            color: var(--dark-text);
            padding: 10px 16px;
            text-decoration: none;
            display: block;
            background: none;
            border: none;
            width: 100%;
            text-align: left;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            border-bottom: 1px solid var(--border-color); /* Separator */
        }

        .dropdown-content button:last-child {
            border-bottom: none;
        }

        .dropdown-content button:hover {
            background-color: var(--light-bg);
            color: var(--primary-color);
        }

        /* --- Loading and Error Messages --- */
        .loading-message,
        .error-message {
            text-align: center;
            padding: 2rem;
            font-size: 1.1rem;
            color: var(--secondary-color);
        }

        .error-message {
            color: #D32F2F; /* Red */
            font-weight: 600;
        }

        .hidden {
            display: none !important;
        }

        /* --- Modals --- */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: #ffffff;
            padding: 2.5rem;
            border-radius: 12px;
            position: relative;
            width: 90%;
            max-width: 500px;
            box-shadow: var(--box-shadow-medium);
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal:not(.hidden) .modal-content {
            transform: translateY(0);
        }

        .close-button {
            color: var(--secondary-color);
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .close-button:hover,
        .close-button:focus {
            color: var(--primary-color);
            text-decoration: none;
        }

        .modal-content h3 {
            font-family: 'Merriweather', serif;
            color: var(--dark-text);
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
            font-weight: 700;
            text-align: center;
        }

        /* --- Forms --- */
        .form-group {
            margin-bottom: 1.2rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--dark-text);
            font-size: 0.95rem;
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 24px); /* Account for padding */
            padding: 0.9rem 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            color: var(--dark-text);
            background-color: #FDFDFD;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(249, 170, 51, 0.2);
            outline: none;
        }

        .form-group small {
            font-size: 0.85rem;
            color: var(--secondary-color);
            margin-top: 0.4rem;
            display: block;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }

        .action-button {
            padding: 0.8rem 1.8rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: var(--box-shadow-light);
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .action-button.save-button {
            background: linear-gradient(45deg, #66BB6A 0%, #4CAF50 100%); /* Green for Save */
            color: white;
        }

        .action-button.save-button:hover {
            background: linear-gradient(45deg, #4CAF50 0%, #388E3C 100%);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-medium);
        }

        .action-button.cancel-button {
            background-color: var(--secondary-color);
            color: white;
        }

        .action-button.cancel-button:hover {
            background-color: #617D8A;
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-medium);
        }

        .add-member-header-btn {
            background: linear-gradient(45deg, #64B5F6 0%, #2196F3 100%); /* Blue for Add Member */
            color: white;
            padding: 0.7rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            margin-left: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.3s ease;
            box-shadow: var(--box-shadow-light);
        }

        .add-member-header-btn:hover {
            background: linear-gradient(45deg, #2196F3 0%, #1976D2 100%);
            transform: translateY(-2px);
            box-shadow: var(--box-shadow-medium);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <nav class="header">
    <div class="navbar">
        <a href="profile.html">Home</a>
        <a href="groups.html">Groups</a>
        <a href="person.html">Persons</a>
        <button id="logout-button">Logout</button>
    </div>
    </nav>
    <div id="main-content" class="table-container content-hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">Person</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Ticket Price</th>
                    <th>Quantity</th>
                    <th>Reference Code</th>
                    <th>Last Payment</th>
                    <th>Balance</th> <th>Created At</th>
                    <th>
                        Actions
                        <button id="add-member-header-btn" class="add-member-header-btn">Add Person</button>
                    </th>
                </tr>
            </thead>
            <tbody id="group-members-table-body">
            </tbody>
        </table>
        <div id="loading" class="loading-message">Loading data...</div>
        <div id="error" class="error-message hidden"></div>
    </div>

    <div id="group-member-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-group-member-modal-button">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="group-member-modal-title">Add New Ticket</h3>
            <form id="group-member-form">
                <input type="hidden" id="member-id">
                <div class="form-group">
                    <label for="member-name">Name:</label>
                    <input type="text" id="member-name" required>
                </div>
                <div class="form-group">
                    <label for="member-ticket-price">Ticket Price:</label>
                    <input type="number" id="member-ticket-price" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="member-quantity">Quantity:</label>
                    <input type="number" id="member-quantity" min="1" required>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-group-member-form-button" class="action-button cancel-button">Cancel</button>
                    <button type="submit" class="action-button save-button">Save</button>
                </div>
            </form>
        </div>
    </div>

    <div id="payment-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-payment-modal-button">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Record New Transaction</h3>
            <form id="payment-form">
                <input type="hidden" id="payment-member-id">
                <p class="mb-4">Transactions for: <strong id="payment-member-name"></strong></p>
                <div class="form-group">
                    <label for="payment-amount">Amount:</label>
                    <input type="number" id="payment-amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="payment-transaction-type">Transaction Type:</label>
                    <select id="payment-transaction-type" required>
                        <option value="Payment">Payment</option>
                        <option value="Refund">Refund</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="payment-reference-code">Confirm Reference Code:</label>
                    <input type="text" id="payment-reference-code" placeholder="Enter member's reference code to confirm" required>
                </div>
                <div class="form-group">
                    <label for="payment-notes">Notes (Optional):</label>
                    <textarea id="payment-notes" rows="3" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-payment-form-button" class="action-button cancel-button">Cancel</button>
                    <button type="submit" class="action-button save-button">Record Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <div id="add-ticket-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button" id="close-add-ticket-modal-button">&times;</span>
            <h3 class="text-xl font-bold text-gray-800 mb-4">Add Tickets for: <strong id="add-ticket-member-name"></strong></h3>
            <form id="add-ticket-form">
                <input type="hidden" id="add-ticket-member-id">
                <p class="mb-4">Current Ticket: <strong id="current-ticket-display"></strong></p>
                <div class="form-group">
                    <label for="add-ticket-quantity">Quantity to Add:</label>
                    <input type="number" id="add-ticket-quantity" min="1" value="1" required>
                    <small class="text-gray-500">Leave "New Ticket Type" and "New Ticket Price" blank to just add more of the current ticket type.</small>
                </div>
                <div class="form-group">
                    <label for="new-ticket-type">New Ticket Type (Optional, to change primary type):</label>
                    <input type="text" id="new-ticket-type" placeholder="-- No Change --">
                </div>
                <div class="form-group">
                    <label for="new-ticket-price">New Ticket Price (Optional, if new type or price change):</label>
                    <input type="number" id="new-ticket-price" step="0.01">
                </div>
                <div class="form-group">
                    <label for="add-ticket-reference-code">Confirm Reference Code:</label>
                    <input type="text" id="add-ticket-reference-code" placeholder="Enter member's reference code to confirm" required>
                </div>
                <div class="form-actions">
                    <button type="button" id="cancel-add-ticket-form-button" class="action-button cancel-button">Cancel</button>
                    <button type="submit" class="action-button save-button">Update Tickets</button>
                </div>
            </form>
        </div>
    </div>

<script src="prevent.js"></script>
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Configuration ---
        const supabaseUrl = 'https://sacjuubsiixwnazxjtpp.supabase.co'; // Replace with your Supabase URL
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNhY2p1dWJzaWl4d25henhqdHBwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2MjQ2MDEsImV4cCI6MjA2ODIwMDYwMX0.U9TJeh25-3eEwr2y5rSmj4Kh37HXJZdWgXeqEqPTzmo'; // Replace with your Supabase Public Key
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- DOM Elements ---
        const groupMembersTableBody = document.getElementById('group-members-table-body');
        const loadingMessage = document.getElementById('loading');
        const errorMessage = document.getElementById('error');
        const mainContent = document.getElementById('main-content');

        // Group Member (Ticket) Modal Elements
        const groupMemberModal = document.getElementById('group-member-modal');
        const closeGroupMemberModalButton = document.getElementById('close-group-member-modal-button');
        const cancelGroupMemberFormButton = document.getElementById('cancel-group-member-form-button');
        const groupMemberForm = document.getElementById('group-member-form');
        const groupMemberModalTitle = document.getElementById('group-member-modal-title');
        const memberIdField = document.getElementById('member-id');
        const memberNameField = document.getElementById('member-name');
        const memberTicketPriceField = document.getElementById('member-ticket-price');
        const memberQuantityField = document.getElementById('member-quantity');

        // Payment Modal Elements
        const paymentModal = document.getElementById('payment-modal');
        const closePaymentModalButton = document.getElementById('close-payment-modal-button');
        const cancelPaymentFormButton = document.getElementById('cancel-payment-form-button');
        const paymentForm = document.getElementById('payment-form');
        const paymentMemberIdField = document.getElementById('payment-member-id');
        const paymentMemberNameDisplay = document.getElementById('payment-member-name');
        const paymentAmountField = document.getElementById('payment-amount');
        const paymentTransactionTypeField = document.getElementById('payment-transaction-type');
        const paymentReferenceCodeField = document.getElementById('payment-reference-code');
        const paymentNotesField = document.getElementById('payment-notes');

        // Add Ticket Modal Elements
        const addTicketModal = document.getElementById('add-ticket-modal');
        const closeAddTicketModalButton = document.getElementById('close-add-ticket-modal-button');
        const cancelAddTicketFormButton = document.getElementById('cancel-add-ticket-form-button');
        const addTicketForm = document.getElementById('add-ticket-form');
        const addTicketMemberIdField = document.getElementById('add-ticket-member-id');
        const addTicketMemberNameDisplay = document.getElementById('add-ticket-member-name');
        const currentTicketDisplay = document.getElementById('current-ticket-display');
        const addTicketQuantityField = document.getElementById('add-ticket-quantity');
        const newTicketTypeField = document.getElementById('new-ticket-type');
        const newTicketPriceField = document.getElementById('new-ticket-price');
        const addTicketReferenceCodeField = document.getElementById('add-ticket-reference-code');


        const INACTIVITY_TIMEOUT = 5 * 60 * 1000; 
        const LOGOUT_REDIRECT_URL = "login.html"; 
        let inactivityTimeoutId;

        // --- Inactivity Handling Functions ---
        async function performLogout() {
            console.log("Logging out due to inactivity...");
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error.message);
            }
            window.location.href = LOGOUT_REDIRECT_URL;
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeoutId); // Clear previous timeout
            inactivityTimeoutId = setTimeout(performLogout, INACTIVITY_TIMEOUT); // Set a new timeout
            console.log("Inactivity timer reset.");
        }

        // --- Authentication and Data Loading ---
        async function checkAuthAndLoadData() {
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error("Error getting session:", error.message);
                errorMessage.textContent = `Authentication error: ${error.message}. Redirecting to login...`;
                errorMessage.classList.remove('hidden');
                setTimeout(() => {
                    window.location.href = LOGOUT_REDIRECT_URL;
                }, 2000);
                return;
            }

            if (!session) {
                window.location.href = LOGOUT_REDIRECT_URL;
            } else {
                mainContent.classList.remove('content-hidden');
                loadingMessage.classList.add('hidden');
                errorMessage.classList.add('hidden');
                fetchGroupMembers(); // Fetch data after successful authentication
                resetInactivityTimer(); // Start/reset inactivity timer once authenticated
            }
        }

        // --- CRUD Operations for Group Members ---
        async function fetchGroupMembers() {
            loadingMessage.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            groupMembersTableBody.innerHTML = '';

            try {
                const { data, error } = await supabase
                    .from('persons')
                    .select('*')
                    .order('created_at', { ascending: false });
                if (error) throw error;

                if (data.length === 0) {
                    groupMembersTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-gray-500">No data found.</td></tr>`;
                } else {
                    for (const member of data) {
                        // Fetch all transactions for this person
                        const { data: transactions, error: txError } = await supabase
                            .from('transactions_person')
                            .select('amount, transaction_type')
                            .eq('person_id', member.id);
                        let totalPayments = 0;
                        let totalRefunds = 0;

                        if (!txError && transactions) {
                            for (const tx of transactions) {
                                if (tx.transaction_type === 'Payment') {
                                    totalPayments += tx.amount;
                                } else if (tx.transaction_type === 'Refund') {
                                    totalRefunds += tx.amount;
                                }
                            }
                        }

                        // Calculate balance
                        const ticketValue = parseFloat(member.ticket_price) * parseInt(member.quantity);
                        const balance = ticketValue - totalPayments + totalRefunds;

                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td class="uuid-cell">${member.id}</td>
                            <td>${member.name}</td>
                            <td class="numeric-cell">${parseFloat(member.ticket_price).toFixed(2)}</td>
                            <td class="numeric-cell">${member.quantity}</td>
                            <td class="code-cell">${member.reference_code}</td>
                            <td>₱${member.last_payment_amount ? parseFloat(member.last_payment_amount).toFixed(2) : '0.00'} (${member.last_payment_date ? new Date(member.last_payment_date).toLocaleDateString() : 'N/A'})</td>
                            <td class="numeric-cell">${balance.toFixed(2)}</td>
                            <td class="timestamp-cell">${new Date(member.created_at).toLocaleString()}</td>
                            <td>
                                <div class="dropdown">
                                    <button class="dots-button" title="Actions">&#x22EE;</button>
                                    <div class="dropdown-content">
                                        <button class="edit-action" data-id="${member.id}">Edit</button>
                                        <button class="delete-action" data-id="${member.id}" data-name="${member.name}" data-price="${member.ticket_price}" data-quantity="${member.quantity}">Delete</button>
                                        <button class="payment-action" data-id="${member.id}" data-name="${member.name}" data-price="${member.ticket_price}" data-quantity="${member.quantity}" data-reference-code="${member.reference_code}">Add Payment</button>
                                        <button class="add-ticket-action" data-id="${member.id}" data-name="${member.name}" data-price="${member.ticket_price}" data-quantity="${member.quantity}" data-reference-code="${member.reference_code}">Add Ticket</button>
                                    </div>
                                </div>
                            </td>
                        `;
                        groupMembersTableBody.appendChild(row);
                    }

                    // Dropdown logic
                    groupMembersTableBody.querySelectorAll('.dots-button').forEach(btn => {
                        btn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            // Close other dropdowns
                            groupMembersTableBody.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
                            btn.parentElement.classList.toggle('show');
                        });
                    });
                    // Close dropdowns when clicking outside
                    document.addEventListener('click', () => {
                        groupMembersTableBody.querySelectorAll('.dropdown').forEach(d => d.classList.remove('show'));
                    });

                    // Attach event listeners to dropdown actions
                    groupMembersTableBody.querySelectorAll('.edit-action').forEach(button => {
                        button.addEventListener('click', (event) => openGroupMemberModalForEdit(event.target.dataset.id));
                    });
                    groupMembersTableBody.querySelectorAll('.delete-action').forEach(button => {
                        button.addEventListener('click', (event) => handleDeleteGroupMember(
                            event.target.dataset.id,
                            event.target.dataset.name,
                            parseFloat(event.target.dataset.price),
                            parseInt(event.target.dataset.quantity)
                        ));
                    });
                    groupMembersTableBody.querySelectorAll('.payment-action').forEach(button => {
                        button.addEventListener('click', (event) => openPaymentModal(
                            event.target.dataset.id,
                            event.target.dataset.name,
                            event.target.dataset.price,
                            event.target.dataset.quantity,
                            event.target.dataset.referenceCode
                        ));
                    });
                    groupMembersTableBody.querySelectorAll('.add-ticket-action').forEach(button => {
                        button.addEventListener('click', (event) => openAddTicketModal(
                            event.target.dataset.id,
                            event.target.dataset.name,
                            parseFloat(event.target.dataset.price),
                            parseInt(event.target.dataset.quantity),
                            event.target.dataset.referenceCode
                        ));
                    });
                }
            } catch (error) {
                console.error('Error fetching group members:', error.message);
                errorMessage.textContent = `Failed to load data: ${error.message}. Please check your Supabase configuration and network connection, and ensure 'persons' table exists.`;
                errorMessage.classList.remove('hidden');
                groupMembersTableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-500">Error loading data.</td></tr>`;
            } finally {
                loadingMessage.classList.add('hidden');
            }
        }

        async function addGroupMember(memberData) {
            try {
                const referenceCode = `${memberData.name.substring(0, 3).toUpperCase()}${Math.floor(1000 + Math.random() * 9000)}`;
                const { data, error } = await supabase
                    .from('persons')
                    .insert([{ ...memberData, reference_code: referenceCode, last_payment_amount: 0.00 }]) // Initialize last payment
                    .select();
                if (error) {
                    throw error;
                }
                console.log('Group member added:', data);
                closeGroupMemberModal();
                fetchGroupMembers(); // Refresh table
                alert('Member and ticket added successfully!');
            } catch (error) {
                console.error('Error adding group member:', error.message);
                alert(`Error adding member: ${error.message}`);
            }
        }

        async function updateGroupMember(id, memberData, oldMemberData) { // Added oldMemberData for comparison
            try {
                const { data, error } = await supabase
                    .from('persons')
                    .update(memberData)
                    .eq('id', id)
                    .select();
                if (error) {
                    throw error;
                }

                // Check if name, ticket_price, or quantity changed to record a transaction
                if (oldMemberData.name !== memberData.name || oldMemberData.ticket_price !== memberData.ticket_price || oldMemberData.quantity !== memberData.quantity) {
                    const transactionAmountChange = (memberData.ticket_price * memberData.quantity) - (oldMemberData.ticket_price * oldMemberData.quantity);
                    const transactionDescription = `Updated ticket details for ${memberData.name}. Old: ${oldMemberData.quantity} x ₱${oldMemberData.ticket_price}, New: ${memberData.quantity} x ₱${memberData.ticket_price}. Change in value: ₱${transactionAmountChange.toFixed(2)}.`;
                    
                    const { error: transactionError } = await supabase
                        .from('transactions_person') // Changed to transactions_person
                        .insert({
                            person_id: id, // Correct foreign key column name
                            amount: transactionAmountChange,
                            transaction_type: 'Ticket_Update',
                            description: transactionDescription,
                            reference_code: oldMemberData.reference_code || 'N/A' // Use existing reference code
                        });
                    if (transactionError) {
                        console.error('Error recording ticket update transaction:', transactionError.message);
                        alert(`Warning: Could not record transaction for ticket update (${transactionError.message}). Member details updated.`);
                    }
                }

                console.log('Group member updated:', data);
                closeGroupMemberModal();
                fetchGroupMembers(); // Refresh table
                alert('Member ticket details updated successfully!');
            } catch (error) {
                console.error('Error updating group member:', error.message);
                alert(`Error updating member: ${error.message}`);
            }
        }

        async function handleDeleteGroupMember(id, name, ticketPrice, quantity) {
            if (!confirm(`Are you sure you want to delete ${name}'s record (${quantity} x ₱${ticketPrice} tickets)? This will also delete associated transactions.`)) {
                return;
            }

            try {
                // First, delete all associated transactions
                const { error: deleteTransactionsError } = await supabase
                    .from('transactions_person')
                    .delete()
                    .eq('person_id', id);

                if (deleteTransactionsError) {
                    throw deleteTransactionsError;
                }
                console.log(`Deleted transactions for person ID: ${id}`);

                // Then, delete the group member record
                const { error: deleteMemberError } = await supabase
                    .from('persons')
                    .delete()
                    .eq('id', id);

                if (deleteMemberError) {
                    throw deleteMemberError;
                }

                console.log('Group member deleted:', id);
                fetchGroupMembers(); // Refresh table
                alert('Member record and associated transactions deleted successfully!');
            } catch (error) {
                console.error('Error deleting group member or associated transactions:', error.message);
                alert(`Error deleting member: ${error.message}`);
            }
        }

        // --- Transaction Operations ---
        async function recordPayment(paymentData) {
            try {
                // 1. Insert into transactions table
                const { error: transactionError } = await supabase
                    .from('transactions_person') // Changed to transactions_person
                    .insert({
                        person_id: paymentData.member_id, // Correct foreign key column name
                        amount: paymentData.amount,
                        transaction_type: paymentData.transaction_type,
                        reference_code: paymentData.reference_code,
                        notes: paymentData.notes,
                        description: `${paymentData.transaction_type} of ₱${paymentData.amount.toFixed(2)} for ${paymentData.member_name}`
                    });
                if (transactionError) {
                    throw transactionError;
                }

                // 2. Update the persons table's last_payment_amount and date
                const { error: updateError } = await supabase
                    .from('persons')
                    .update({
                        last_payment_amount: paymentData.amount,
                        last_payment_date: new Date().toISOString()
                    })
                    .eq('id', paymentData.member_id);
                if (updateError) {
                    throw updateError;
                }

                alert(`Payment of ₱${paymentData.amount.toFixed(2)} for ${paymentData.member_name} recorded successfully!`);
                closePaymentModal();
                fetchGroupMembers(); // Refresh table
            } catch (error) {
                console.error('Error recording payment:', error.message);
                alert(`Error recording payment: ${error.message}`);
            }
        }

        // --- Add Ticket Operations ---
        async function updateGroupMemberTickets(memberId, memberName, currentTicketPrice, quantityToAdd, newTicketType = null, newTicketPrice = null, referenceCode) {
            try {
                // Fetch the current member data to get the existing quantity and other details
                const { data: member, error: fetchError } = await supabase
                    .from('persons')
                    .select('quantity, ticket_price, name')
                    .eq('id', memberId)
                    .single();

                if (fetchError || !member) {
                    console.error('Error fetching member for adding tickets:', fetchError?.message);
                    alert('Could not fetch member data to update tickets.');
                    return;
                }

                const updatedQuantity = member.quantity + quantityToAdd;
                const finalTicketType = newTicketType && newTicketType.trim() !== '' ? newTicketType.trim() : member.name;
                const finalTicketPrice = newTicketPrice !== null && newTicketPrice !== '' ? parseFloat(newTicketPrice) : member.ticket_price;
                
                const transactionAmount = quantityToAdd * finalTicketPrice; // Value of the tickets being added
                const transactionDescription = `Added ${quantityToAdd} tickets (type: ${finalTicketType}, price: ₱${finalTicketPrice.toFixed(2)}) for ${member.name}. Total: ₱${transactionAmount.toFixed(2)}.`;

                // 1. Update the persons table
                const { error: updateMemberError } = await supabase
                    .from('persons')
                    .update({
                        quantity: updatedQuantity,
                        name: finalTicketType, // Update member's primary ticket type name
                        ticket_price: finalTicketPrice // Update member's primary ticket price
                    })
                    .eq('id', memberId);
                if (updateMemberError) {
                    throw updateMemberError;
                }

                // 2. Insert into transactions_person table
                const { error: transactionError } = await supabase
                    .from('transactions_person') // Changed to transactions_person
                    .insert({
                        person_id: memberId, // Correct foreign key column name
                        amount: transactionAmount,
                        transaction_type: 'Ticket_Add',
                        description: transactionDescription,
                        reference_code: referenceCode
                    });
                if (transactionError) {
                    throw transactionError;
                }

                console.log('Group member tickets updated and transaction recorded.');
                closeAddTicketModal();
                fetchGroupMembers(); // Refresh table
                alert('Tickets updated and transaction recorded successfully!');
            } catch (error) {
                console.error('Error updating member tickets:', error.message);
                alert(`Error updating tickets: ${error.message}`);
            }
        }

        // --- Modal Handling ---
        // Group Member (Ticket) Modal Functions
        function openGroupMemberModalForAdd() {
            groupMemberModalTitle.textContent = 'Add New Member & Ticket';
            memberIdField.value = ''; // Clear ID for new record
            groupMemberForm.reset(); // Clear form fields
            groupMemberModal.classList.remove('hidden');
        }

        async function openGroupMemberModalForEdit(id) {
            groupMemberModalTitle.textContent = 'Edit Member & Ticket';
            groupMemberModal.classList.remove('hidden');
            try {
                const { data, error } = await supabase
                    .from('persons')
                    .select('*')
                    .eq('id', id)
                    .single();
                if (error) {
                    throw error;
                }
                // Populate form fields with existing data
                memberIdField.value = data.id;
                memberNameField.value = data.name;
                memberTicketPriceField.value = data.ticket_price;
                memberQuantityField.value = data.quantity;
            } catch (error) {
                console.error('Error fetching member for edit:', error.message);
                alert(`Error loading member details for edit: ${error.message}`);
                closeGroupMemberModal();
            }
        }

        function closeGroupMemberModal() {
            groupMemberModal.classList.add('hidden');
        }

        // Payment Modal Functions
        function openPaymentModal(memberId, memberName, ticketPrice, quantity, referenceCode) {
            paymentMemberIdField.value = memberId;
            paymentMemberNameDisplay.textContent = memberName;
            paymentReferenceCodeField.value = referenceCode; // Pre-fill with member's reference code
            paymentForm.reset(); // Clear form fields
            paymentModal.classList.remove('hidden');
        }

        function closePaymentModal() {
            paymentModal.classList.add('hidden');
        }

        // Add Ticket Modal Functions
        async function openAddTicketModal(memberId, memberName, ticketPrice, quantity, referenceCode) {
            addTicketMemberIdField.value = memberId;
            addTicketMemberNameDisplay.textContent = memberName;
            currentTicketDisplay.textContent = `${quantity} x ₱${parseFloat(ticketPrice).toFixed(2)}`; // Display current ticket info
            addTicketReferenceCodeField.value = referenceCode; // Pre-fill reference code
            addTicketForm.reset(); // Clear form fields
            addTicketModal.classList.remove('hidden');
        }

        function closeAddTicketModal() {
            addTicketModal.classList.add('hidden');
        }

        // --- Event Listeners ---
        document.getElementById('logout-button').addEventListener('click', performLogout);
        document.getElementById('add-member-header-btn').addEventListener('click', openGroupMemberModalForAdd);

        // Group Member Modal Event Listeners
        closeGroupMemberModalButton.addEventListener('click', closeGroupMemberModal);
        cancelGroupMemberFormButton.addEventListener('click', closeGroupMemberModal);
        groupMemberForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = memberIdField.value;
            const memberData = {
                name: memberNameField.value,
                ticket_price: parseFloat(memberTicketPriceField.value),
                quantity: parseInt(memberQuantityField.value)
            };

            if (id) {
                // Fetch old data to determine if a transaction needs to be recorded
                const { data: oldMemberData, error: fetchOldError } = await supabase
                    .from('persons')
                    .select('name, ticket_price, quantity, reference_code')
                    .eq('id', id)
                    .single();

                if (fetchOldError) {
                    console.error('Error fetching old member data:', fetchOldError.message);
                    alert('Could not fetch old member data for update. Please try again.');
                    return;
                }
                updateGroupMember(id, memberData, oldMemberData);
            } else {
                addGroupMember(memberData);
            }
        });

        // Payment Modal Event Listeners
        closePaymentModalButton.addEventListener('click', closePaymentModal);
        cancelPaymentFormButton.addEventListener('click', closePaymentModal);
        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const memberId = paymentMemberIdField.value;
            const amount = parseFloat(paymentAmountField.value);
            const transactionType = paymentTransactionTypeField.value;
            const referenceCode = paymentReferenceCodeField.value;
            const notes = paymentNotesField.value;
            const memberName = paymentMemberNameDisplay.textContent;

            if (isNaN(amount) || amount <= 0) {
                alert('Amount must be a positive number.');
                return;
            }

            // Reference code verification
            const { data: person, error: personError } = await supabase
                .from('persons')
                .select('reference_code')
                .eq('id', memberId)
                .single();

            if (personError || !person || person.reference_code !== referenceCode) {
                alert('Invalid Reference Code. Please ensure it matches the member\'s code.');
                console.error('Reference code verification failed:', personError?.message || 'Code mismatch');
                return;
            }

            recordPayment({ member_id: memberId, member_name: memberName, amount, transaction_type: transactionType, reference_code: referenceCode, notes });
        });

        // Add Ticket Modal Event Listeners
        closeAddTicketModalButton.addEventListener('click', closeAddTicketModal);
        cancelAddTicketFormButton.addEventListener('click', closeAddTicketModal);
        addTicketForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            const memberId = addTicketMemberIdField.value;
            const memberName = addTicketMemberNameDisplay.textContent; // Get the member's current name
            const quantityToAdd = parseInt(addTicketQuantityField.value);
            const newTicketType = newTicketTypeField.value;
            const newTicketPrice = newTicketPriceField.value; // Keep as string for now, parse later
            const referenceCode = addTicketReferenceCodeField.value;

            if (isNaN(quantityToAdd) || quantityToAdd <= 0) {
                alert('Quantity to Add must be a positive number.');
                return;
            }

            // Reference code verification
            const { data: person, error: personError } = await supabase
                .from('persons')
                .select('reference_code')
                .eq('id', memberId)
                .single();

            if (personError || !person || person.reference_code !== referenceCode) {
                alert('Invalid Reference Code. Please ensure it matches the member\'s code.');
                console.error('Reference code verification failed:', personError?.message || 'Code mismatch');
                return;
            }

            let finalNewTicketPrice = null;
            if (newTicketPrice !== '') {
                finalNewTicketPrice = parseFloat(newTicketPrice);
                if (isNaN(finalNewTicketPrice) || finalNewTicketPrice <= 0) {
                    alert('New Ticket Price must be a positive number if provided.');
                    return;
                }
            }

            await updateGroupMemberTickets(memberId, memberName, null, quantityToAdd, newTicketType, finalNewTicketPrice, referenceCode);
        });


        // --- Initial Load ---
        checkAuthAndLoadData();

        // --- Event Listeners for Inactivity Reset ---
        ['mousemove', 'mousedown', 'keydown', 'scroll', 'touchstart'].forEach(eventName => {
            document.addEventListener(eventName, resetInactivityTimer, true);
        });
    </script>
</body>
</html>
